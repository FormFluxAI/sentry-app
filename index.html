<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANGUARD DIAGNOSTIC</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --neon-blue:#00f3ff; --neon-green:#00ff41; --neon-red:#ff003c; --bg:#050505; --panel:#141414; }
        body { background:var(--bg); color:#eee; font-family:'Segoe UI',monospace; margin:0; height:100vh; overflow:hidden; display:flex; flex-direction:column; }
        
        /* LOGIN / BOOT */
        #login-layer { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:5000; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .boot-log { width:90%; height:150px; background:#111; border:1px solid #333; color:#0f0; font-size:0.7rem; padding:10px; overflow-y:auto; margin-top:20px; font-family:monospace; text-align:left; }
        .login-btn { padding:15px 30px; background:var(--neon-blue); border:none; border-radius:50px; font-weight:900; margin-top:20px; cursor:pointer; }
        
        /* MAIN LAYOUT */
        header { padding:15px; background:rgba(0,0,0,0.9); border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .brand { color:var(--neon-blue); font-weight:900; letter-spacing:2px; }
        
        #viewport { flex:1; position:relative; overflow:hidden; }
        .view { position:absolute; top:0; left:0; width:100%; height:100%; overflow-y:auto; padding:15px; padding-bottom:120px; background:var(--bg); transform:translateX(100%); transition:0.3s; }
        .view.active { transform:translateX(0); }

        /* CARDS */
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .card { background:var(--panel); border:1px solid #333; border-radius:10px; padding:15px; min-height:120px; position:relative; transition:0.2s; }
        .card.selected { border-color:var(--neon-blue); background:rgba(0,243,255,0.1); }
        .card.armed { border-color:var(--neon-green); background:rgba(0,50,0,0.3); }
        .card.alert { border-color:var(--neon-red); background:rgba(50,0,0,0.5); animation:flash 0.5s infinite; }
        @keyframes flash { 0%,100%{border-color:var(--neon-red);} 50%{border-color:#000;} }

        /* LIVE DIAGNOSTICS */
        .diag-bar { background:#111; padding:10px; font-size:0.7rem; color:#aaa; border-bottom:1px solid #333; display:flex; justify-content:space-between; }
        .diag-val { color:var(--neon-green); font-family:monospace; }

        /* CONTROLS */
        .master-bar { position:fixed; bottom:80px; left:0; width:100%; padding:0 15px; pointer-events:none; opacity:0; transition:0.3s; transform:translateY(20px); z-index:90; }
        .master-bar.visible { opacity:1; pointer-events:all; transform:translateY(0); }
        .master-btn { width:100%; background:var(--neon-blue); color:#000; font-weight:900; padding:15px; border:none; border-radius:50px; box-shadow:0 0 15px var(--neon-blue); }
        .master-btn.disarm { background:var(--neon-red); color:#fff; box-shadow:0 0 15px var(--neon-red); }

        /* FOOTER */
        .footer { position:fixed; bottom:0; left:0; width:100%; height:70px; background:#000; border-top:1px solid #333; display:flex; justify-content:space-around; align-items:center; z-index:200; }
        .nav-btn { background:none; border:none; color:#666; font-size:1.5rem; padding:10px; }
        .nav-btn.active { color:var(--neon-blue); }
        .panic-btn { width:55px; height:55px; border-radius:50%; background:var(--neon-red); border:none; color:#fff; font-weight:bold; margin-top:-25px; box-shadow:0 0 10px var(--neon-red); }

        /* HIDDEN */
        #cam { position:fixed; top:-9999px; }
        #strobe-layer { position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:none; pointer-events:none; }
        @keyframes strobe { 0%{background:#fff;} 50%{background:#000;} 100%{background:#fff;} }
        #map-container { width:100%; height:100%; }
    </style>
</head>
<body>
    <div id="strobe-layer"></div>

    <div id="login-layer">
        <h1 style="color:var(--neon-blue);">VANGUARD</h1>
        <div style="color:#666; margin-bottom:20px;">DIAGNOSTIC KERNEL v10.0</div>
        
        <button class="login-btn" onclick="initSystem()">INITIALIZE SENSORS</button>
        <button id="ios-btn" class="login-btn" style="display:none; background:#333; color:#fff; margin-top:10px;" onclick="iosPerms()">GRANT IOS SENSORS</button>
        
        <div class="boot-log" id="console">waiting for command...</div>
    </div>

    <header>
        <div class="brand">VANGUARD</div>
        <div id="status" style="font-size:0.7rem; font-weight:bold; color:#666;">STANDBY</div>
    </header>

    <div class="diag-bar">
        <div>AUDIO: <span id="val-audio" class="diag-val">0</span></div>
        <div>LIGHT: <span id="val-light" class="diag-val">0</span></div>
        <div>MOTION: <span id="val-motion" class="diag-val">0</span></div>
    </div>

    <div id="viewport">
        <div id="dashboard" class="view active">
            <div class="grid" id="card-grid"></div>
        </div>

        <div id="intel" class="view">
            <h2>INTEL LOG</h2>
            <div id="log-list" style="font-family:monospace; font-size:0.8rem;"></div>
        </div>
        
        <div id="map-view" class="view"><div id="map-container"></div></div>
        
        <div id="detail" class="view">
            <button onclick="nav('dashboard')" style="background:none; border:none; color:#aaa; margin-bottom:10px;">&larr; BACK</button>
            <h1 id="det-title" style="color:var(--neon-blue); margin:0;">MODULE</h1>
            <p id="det-desc" style="color:#666;">Desc</p>
            
            <div style="background:#111; padding:15px; margin-top:20px; border-radius:8px;">
                <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem;">
                    <span>SENSITIVITY</span><span id="lbl-sens">50%</span>
                </div>
                <input type="range" id="inp-sens" min="1" max="100" value="50" style="width:100%; margin-top:10px;" oninput="updateSens(this.value)">
            </div>
            
            <div id="extra-settings" style="margin-top:20px;"></div>
        </div>
    </div>

    <div class="master-bar" id="master-bar">
        <button class="master-btn" id="master-btn">ARM SYSTEM</button>
    </div>

    <div class="footer">
        <button class="nav-btn active" onclick="nav('dashboard')"><i class="material-icons">grid_view</i></button>
        <button class="panic-btn" onclick="panic()"><i class="material-icons">priority_high</i></button>
        <button class="nav-btn" onclick="nav('map-view')"><i class="material-icons">map</i></button>
        <button class="nav-btn" onclick="nav('intel')"><i class="material-icons">history</i></button>
    </div>

    <video id="cam" autoplay playsinline muted></video>
    <canvas id="cvs" style="display:none;"></canvas>

<script>
    // --- STATE ---
    const mods = {
        intruder: { id:'intruder', icon:'motion_photos_on', name:"Intruder", desc:"Visual Motion", armed:false, selected:false, sens:50 },
        seismic:  { id:'seismic', icon:'vibration', name:"Seismic", desc:"Vibration Detect", armed:false, selected:false, sens:85 },
        lumen:    { id:'lumen', icon:'light_mode', name:"Lumen", desc:"Light/Pocket Trap", armed:false, selected:false, sens:50, ready:false },
        audio:    { id:'audio', icon:'graphic_eq', name:"Audio", desc:"Loud Noise Detect", armed:false, selected:false, sens:70 },
        snoop:    { id:'snoop', icon:'touch_app', name:"Snoop", desc:"Device Moved", armed:false, selected:false, sens:90 },
        wreck:    { id:'wreck', icon:'car_crash', name:"Wreck", desc:"Impact Detect", armed:false, selected:false, sens:40 },
        net:      { id:'net', icon:'wifi_off', name:"Net-Sentry", desc:"Connection Cut", armed:false, selected:false, sens:null },
        deadman:  { id:'deadman', icon:'hourglass_bottom', name:"Dead Man", desc:"Safety Timer", armed:false, selected:false, timer:5 }
    };

    let stream, audioCtx, analyser;
    let accBase=null, lastLight=0;
    let map, usrMarker;
    let detailMod = null;
    let dmInt = null;

    // --- SYSTEM DIAGNOSTICS (BOOT) ---
    function sysLog(msg, type='info') {
        const c = document.getElementById('console');
        const l = document.createElement('div');
        l.innerText = `> ${msg}`;
        l.style.color = type==='err'?'#f00':(type==='ok'?'#0f0':'#aaa');
        c.appendChild(l);
        c.scrollTop = c.scrollHeight;
    }

    async function initSystem() {
        sysLog("Initializing Core...");
        
        // 1. Camera check
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
            document.getElementById('cam').srcObject = stream;
            // ESSENTIAL: Force play for mobile browsers
            document.getElementById('cam').play(); 
            sysLog("Camera/Mic: ONLINE", 'ok');
        } catch(e) {
            sysLog("Camera FAILED: " + e.message, 'err');
            sysLog("TIP: Use HTTPS or Localhost", 'err');
        }

        // 2. Audio Context
        try {
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();
            if(stream) {
                analyser = audioCtx.createAnalyser();
                const src = audioCtx.createMediaStreamSource(stream);
                src.connect(analyser);
            }
            sysLog("Audio Engine: READY", 'ok');
        } catch(e) { sysLog("Audio Error: "+e.message, 'err'); }

        // 3. Sensor Check
        if(typeof DeviceMotionEvent.requestPermission === 'function') {
            sysLog("iOS Detected: Click 'GRANT IOS SENSORS'", 'err');
            document.getElementById('ios-btn').style.display='block';
        } else {
            sysLog("Sensors: Auto-Bound", 'ok');
            startLoops();
        }

        // 4. Map
        try {
            map = L.map('map-container').setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            sysLog("Map: ONLINE", 'ok');
        } catch(e) { sysLog("Map Error (Check Wifi)", 'err'); }

        // Finish if not iOS
        if(document.getElementById('ios-btn').style.display === 'none') {
            setTimeout(() => document.getElementById('login-layer').style.display='none', 1500);
            renderGrid();
        }
    }

    function iosPerms() {
        DeviceMotionEvent.requestPermission().then(res => {
            if(res==='granted') {
                sysLog("iOS Sensors: GRANTED", 'ok');
                startLoops();
                setTimeout(() => document.getElementById('login-layer').style.display='none', 1000);
                renderGrid();
            } else sysLog("iOS Sensors: DENIED", 'err');
        }).catch(e => sysLog("iOS Error: "+e, 'err'));
    }

    function startLoops() {
        requestAnimationFrame(visLoop);
        window.addEventListener('devicemotion', motionLoop);
        window.addEventListener('offline', () => { if(mods.net.armed) alertTrigger('net'); });
        
        // Network heartbeat
        setInterval(() => {
            if(mods.audio.armed && audioCtx.state === 'suspended') audioCtx.resume();
        }, 1000);
    }

    // --- UI LOGIC ---
    function renderGrid() {
        const g = document.getElementById('card-grid');
        g.innerHTML = '';
        Object.values(mods).forEach(m => {
            const d = document.createElement('div');
            d.className = `card ${m.selected?'selected':''} ${m.armed?'armed':''}`;
            d.id = `card-${m.id}`;
            d.onclick = () => toggleSel(m.id);
            d.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <div style="width:10px; height:10px; background:${m.armed?'#0f0':'#333'}; border-radius:50%;"></div>
                    <i class="material-icons" style="color:#666;" onclick="openDet('${m.id}', event)">settings</i>
                </div>
                <i class="material-icons" style="font-size:2rem; margin:10px 0; color:${m.armed?'#0f0':'#666'}">${m.icon}</i>
                <div><b>${m.name}</b><br><small>${m.desc}</small></div>
            `;
            g.appendChild(d);
        });
        updMaster();
    }

    function toggleSel(id) { mods[id].selected = !mods[id].selected; renderGrid(); }
    
    function updMaster() {
        const nSel = Object.values(mods).filter(m=>m.selected).length;
        const nArm = Object.values(mods).filter(m=>m.armed).length;
        const bar = document.getElementById('master-bar');
        const btn = document.getElementById('master-btn');
        
        if(nSel > 0) {
            bar.classList.add('visible'); btn.innerText = `ARM ${nSel} MODULES`;
            btn.className = "master-btn"; btn.onclick = armSel;
        } else if(nArm > 0) {
            bar.classList.add('visible'); btn.innerText = "DISARM ALL";
            btn.className = "master-btn disarm"; btn.onclick = disarmAll;
        } else bar.classList.remove('visible');
    }

    function armSel() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        Object.keys(mods).forEach(k => {
            if(mods[k].selected) {
                mods[k].armed = true; mods[k].selected = false;
                if(k==='seismic') accBase = null; // reset baseline
                if(k==='lumen') { mods[lumen].ready=false; setTimeout(()=>mods.lumen.ready=true, 3000); }
                if(k==='deadman') startTimer();
            }
        });
        document.getElementById('status').innerText = "SYSTEM ARMED";
        document.getElementById('status').style.color = "var(--neon-green)";
        renderGrid();
    }

    function disarmAll() {
        Object.keys(mods).forEach(k => mods[k].armed = false);
        clearInterval(dmInt);
        document.getElementById('status').innerText = "STANDBY";
        document.getElementById('status').style.color = "#666";
        renderGrid();
    }

    function openDet(id, e) {
        e.stopPropagation();
        detailMod = id;
        document.getElementById('det-title').innerText = mods[id].name;
        document.getElementById('det-desc').innerText = mods[id].desc;
        if(mods[id].sens) {
            document.getElementById('inp-sens').value = mods[id].sens;
            document.getElementById('lbl-sens').innerText = mods[id].sens+"%";
            document.getElementById('inp-sens').parentElement.style.display='block';
        } else {
            document.getElementById('inp-sens').parentElement.style.display='none';
        }
        nav('detail');
    }

    function updateSens(v) {
        if(detailMod) { mods[detailMod].sens = v; document.getElementById('lbl-sens').innerText = v+"%"; }
    }

    // --- CORE LOOPS (THE FIX) ---
    function visLoop() {
        requestAnimationFrame(visLoop);
        if(!stream) return;
        
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const vid = document.getElementById('cam');

        // FORCE VIDEO PLAY if paused
        if(vid.paused) vid.play();

        if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
            cvs.width=50; cvs.height=50;
            ctx.drawImage(vid,0,0,50,50);
            const d = ctx.getImageData(0,0,50,50).data;
            let l=0; for(let i=0; i<d.length; i+=4) l+=d[i];
            const avg = Math.floor(l/2500);

            document.getElementById('val-light').innerText = avg;

            // Intruder
            const delta = Math.abs(avg - lastLight);
            if(mods.intruder.armed && delta > ((100-mods.intruder.sens)*0.5) && delta > 2) alertTrigger('intruder');

            // Lumen
            if(mods.lumen.armed && mods.lumen.ready) {
                 // Trigger if light gets BRIGHTER than threshold
                 const thresh = 255 - (mods.lumen.sens * 2);
                 if(avg > thresh) alertTrigger('lumen');
            }

            lastLight = avg;
        }

        if(analyser) {
            const d = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(d);
            const vol = Math.floor(d.reduce((a,b)=>a+b)/d.length);
            document.getElementById('val-audio').innerText = vol;
            
            if(mods.audio.armed && vol > (255-(mods.audio.sens*2))) alertTrigger('audio');
        }
    }

    function motionLoop(e) {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        if(!accBase) accBase = acc;

        const diff = Math.abs(acc.x-accBase.x) + Math.abs(acc.y-accBase.y);
        const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;
        
        document.getElementById('val-motion').innerText = diff.toFixed(2);

        // Seismic
        if(mods.seismic.armed) {
            const thresh = (100-mods.seismic.sens)/100 + 0.05;
            if(diff > thresh) alertTrigger('seismic');
        }

        // Snoop
        if(mods.snoop.armed && diff > 1.5) alertTrigger('snoop');

        // Wreck
        if(mods.wreck.armed && g > (2 + ((100-mods.wreck.sens)/20))) alertTrigger('wreck');

        // Fast Drift (Reset base quicker to avoid getting stuck)
        accBase.x += (acc.x - accBase.x) * 0.1;
        accBase.y += (acc.y - accBase.y) * 0.1;
    }

    function alertTrigger(id) {
        const card = document.getElementById(`card-${id}`);
        if(card && !card.classList.contains('alert')) {
            card.classList.add('alert');
            
            // Log
            const log = document.getElementById('log-list');
            const entry = document.createElement('div');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${mods[id].name} TRIGGERED`;
            entry.style.borderBottom = "1px solid #333";
            log.prepend(entry);

            // Sound
            if(audioCtx) {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.value = 800; o.start(); o.stop(audioCtx.currentTime+0.5);
            }

            setTimeout(() => card.classList.remove('alert'), 3000);
        }
    }

    // --- UTILS ---
    function startTimer() {
        let t = mods.deadman.timer * 60;
        clearInterval(dmInt);
        dmInt = setInterval(() => {
            t--;
            if(t<=0) { alertTrigger('deadman'); clearInterval(dmInt); }
        }, 1000);
    }

    function nav(viewId) {
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'map-view' && map) setTimeout(()=>map.invalidateSize(), 200);
    }
    
    function panic() { alert("PANIC BEACON BROADCASTING"); }

</script>
</body>
</html>
