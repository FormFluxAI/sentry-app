<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANGUARD SIGMA 7.1</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #00ff41;
            --neon-red: #ff003c;
            --bg: #050505;
            --panel: #121212;
            --border: 1px solid #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        body { background-color: var(--bg); color: #eee; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        header { padding: 15px; background: rgba(0,0,0,0.95); border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .brand { color: var(--neon-blue); font-weight: 900; letter-spacing: 1px; }
        
        /* VIEWS */
        #viewport { flex: 1; position: relative; overflow: hidden; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 15px; padding-bottom: 100px;
            background: var(--bg); transition: transform 0.3s; transform: translateX(100%);
        }
        .view.active { transform: translateX(0); }

        /* GRID */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card {
            background: var(--panel); border: var(--border); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 120px; position: relative;
        }
        .card.armed { border-color: var(--neon-green); background: rgba(0, 50, 0, 0.2); }
        .card.alert { border-color: var(--neon-red); background: rgba(50, 0, 0, 0.5); animation: flash 0.5s infinite; }
        .dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .card.armed .dot { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        .icon { font-size: 1.8rem; color: #666; }
        .card.armed .icon { color: var(--neon-green); }

        /* DETAIL CONTROLS */
        .setting-group { margin: 20px 0; background: #111; padding: 15px; border-radius: 8px; }
        .setting-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 10px; }
        input[type=range] { width: 100%; background: #333; height: 5px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--neon-blue); border-radius: 50%; }
        
        .big-toggle { width: 100%; padding: 20px; background: #222; border: 1px solid #444; color: #fff; font-size: 1.2rem; border-radius: 12px; margin-top: 10px; }
        .big-toggle.armed { background: var(--neon-green); color: black; border-color: var(--neon-green); }

        /* FOOTER */
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #000; border-top: var(--border); display: flex; z-index: 200; padding: 10px; gap: 10px; }
        .panic-btn { flex: 2; background: var(--neon-red); color: white; border: none; border-radius: 8px; font-weight: 900; letter-spacing: 2px; }
        .log-btn { flex: 1; background: #222; color: #ccc; border: 1px solid #444; border-radius: 8px; }

        @keyframes flash { 0%, 100% { border-color: var(--neon-red); } 50% { border-color: #000; } }
        #strobe-layer { position: fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:none; pointer-events: none; }
        @keyframes strobe { 0% { background: white; } 50% { background: black; } 100% { background: white; } }
    </style>
</head>
<body>

    <div id="strobe-layer"></div>

    <header>
        <button id="backBtn" onclick="goHome()" style="background:none; border:none; color:white; display:none;"><i class="material-icons">arrow_back</i></button>
        <div class="brand">VANGUARD</div>
        <div style="font-size: 0.7rem; color: #666;">SIGMA 7.1</div>
    </header>

    <div id="viewport">
        <div id="dashboard" class="view active">
            <div class="grid">
                <div class="card" id="card-intruder" onclick="openDetail('intruder')">
                    <div class="dot"></div><i class="material-icons icon">motion_photos_on</i>
                    <div><h3>Intruder</h3><p>Cam + Strobe</p></div>
                </div>
                <div class="card" id="card-seismic" onclick="openDetail('seismic')">
                    <div class="dot"></div><i class="material-icons icon">vibration</i>
                    <div><h3>Seismic</h3><p>Door Guard</p></div>
                </div>
                <div class="card" id="card-lumen" onclick="openDetail('lumen')">
                    <div class="dot"></div><i class="material-icons icon">light_mode</i>
                    <div><h3>Lumen</h3><p>Pocket Trap</p></div>
                </div>
                <div class="card" id="card-net" onclick="openDetail('net')">
                    <div class="dot"></div><i class="material-icons icon">wifi_off</i>
                    <div><h3>Net-Sentry</h3><p>Offline Detect</p></div>
                </div>
                <div class="card" id="card-deadman" onclick="openDetail('deadman')">
                    <div class="dot"></div><i class="material-icons icon">hourglass_bottom</i>
                    <div><h3>Dead Man</h3><p>Timer</p></div>
                </div>
                <div class="card" id="card-wreck" onclick="openDetail('wreck')">
                    <div class="dot"></div><i class="material-icons icon">car_crash</i>
                    <div><h3>Wreck</h3><p>Impact</p></div>
                </div>
            </div>
        </div>

        <div id="detail" class="view">
            <h1 id="det-title" style="color:var(--neon-blue); margin:0;">MODULE</h1>
            <p id="det-desc" style="color:#888;">Description</p>

            <div class="setting-group" id="grp-sens">
                <div class="setting-label"><span>SENSITIVITY</span><span id="lbl-sens">50%</span></div>
                <input type="range" id="inp-sens" min="1" max="100" value="50" oninput="updSet('sens', this.value)">
            </div>

            <div class="setting-group" id="grp-strobe" style="display:none;">
                <div class="setting-label"><span>COUNTER-MEASURE</span></div>
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="chk-strobe" onchange="mods.intruder.strobe = this.checked"> 
                    Enable Blinding Strobe
                </label>
            </div>

            <div id="net-instruction" style="display:none; color: var(--neon-blue); font-size: 0.8rem; margin: 10px 0;">
                TESTING: Arm this module, then enable AIRPLANE MODE to trigger alarm.
            </div>

            <button class="big-toggle" id="arm-btn" onclick="toggleArm()">ARM MODULE</button>

            <div style="background:#111; padding:15px; border-radius:8px; margin-top:20px;">
                <label style="font-size:0.7rem; color:#555;">LIVE SENSOR DATA</label>
                <div id="live-data" style="font-family:monospace; color:var(--neon-green); font-size:1.1rem;">--</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="panic-btn" onclick="panic()">PANIC</button>
        <button class="log-btn" onclick="downloadLogs()"><i class="material-icons">download</i></button>
    </div>

    <video id="cam" autoplay playsinline muted style="position:fixed; top:-5000px;"></video>
    <canvas id="cvs" style="display:none;"></canvas>

<script>
    // --- STATE ---
    const mods = {
        intruder: { name:"Intruder", desc:"Visual Motion", armed:false, sens:50, strobe:false },
        seismic: { name:"Seismic", desc:"Detects vibrations. Place on door handle or floor.", armed:false, sens:85 },
        lumen: { name:"Lumen", desc:"Alarms when removed from dark pocket/bag.", armed:false, sens:50, ready:false },
        net: { name:"Net-Sentry", desc:"Alarms if Internet/Wi-Fi is cut.", armed:false, sens:null },
        deadman: { name:"Dead Man", desc:"Safety Timer", armed:false, timer:5 },
        wreck: { name:"Wreck", desc:"Impact G-Force", armed:false, sens:40 }
    };

    let curMod = null;
    let stream, audioCtx;
    let logs = [];
    let lastLight = 0;
    let accBase = null;
    let netCheckInt = null;

    // --- INIT ---
    // Start automatically on click
    document.body.addEventListener('click', initSys, { once: true });

    async function initSys() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
            document.getElementById('cam').srcObject = stream;
            
            if(typeof DeviceMotionEvent.requestPermission==='function') await DeviceMotionEvent.requestPermission();
            
            audioCtx = new (window.AudioContext||window.webkitAudioContext)();

            // Start Loops
            requestAnimationFrame(visLoop);
            
            // Network Listener
            window.addEventListener('offline', () => { if(mods.net.armed) trigger('net'); });

        } catch(e) { console.log(e); }
    }

    // --- UI NAVIGATION ---
    function goHome() {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('dashboard').classList.add('active');
        document.getElementById('backBtn').style.display='none';
        curMod = null;
    }

    function openDetail(key) {
        curMod = key;
        const m = mods[key];
        document.getElementById('det-title').innerText = m.name;
        document.getElementById('det-desc').innerText = m.desc;
        
        // UI Toggles
        document.getElementById('grp-sens').style.display = (key==='net' || key==='deadman') ? 'none' : 'block';
        document.getElementById('grp-strobe').style.display = (key==='intruder') ? 'block' : 'none';
        document.getElementById('net-instruction').style.display = (key==='net') ? 'block' : 'none';

        if(key !== 'net' && key !== 'deadman') {
            document.getElementById('inp-sens').value = m.sens;
            document.getElementById('lbl-sens').innerText = m.sens + "%";
        }

        updateArmBtn();
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('detail').classList.add('active');
        document.getElementById('backBtn').style.display='block';
    }

    function updSet(type, val) {
        if(!curMod) return;
        if(type === 'sens') {
            mods[curMod].sens = parseInt(val);
            document.getElementById('lbl-sens').innerText = val + "%";
        }
    }

    function toggleArm() {
        if(!curMod) return;
        mods[curMod].armed = !mods[curMod].armed;
        
        // LUMEN: 3 Second Delay
        if(curMod === 'lumen' && mods.lumen.armed) {
            mods.lumen.ready = false;
            document.getElementById('arm-btn').innerText = "ARMING IN 3s...";
            setTimeout(() => { mods.lumen.ready = true; updateArmBtn(); }, 3000);
        }

        // SEISMIC: Reset Baseline
        if(curMod === 'seismic' && mods.seismic.armed) accBase = null;

        updateArmBtn();
        const c = document.getElementById('card-'+curMod);
        if(mods[curMod].armed) c.classList.add('armed'); else c.classList.remove('armed','alert');
    }

    function updateArmBtn() {
        const b = document.getElementById('arm-btn');
        if(mods[curMod].armed) { 
            b.classList.add('armed'); 
            b.innerText = mods[curMod].ready === false ? "ARMING..." : "DISARM"; 
        } else { 
            b.classList.remove('armed'); 
            b.innerText = "ARM MODULE"; 
        }
    }

    // --- PHYSICS ENGINE (THE FIX) ---
    function visLoop() {
        requestAnimationFrame(visLoop);
        if(!stream) return;
        
        // 1. Get Light Data
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const vid = document.getElementById('cam');
        
        cvs.width=50; cvs.height=50;
        ctx.drawImage(vid,0,0,50,50);
        const d = ctx.getImageData(0,0,50,50).data;
        let l=0; for(let i=0; i<d.length; i+=4) l+=d[i];
        const avg = Math.floor(l/2500); // 0-255 brightness

        // 2. INTRUDER LOGIC (Fixed Math)
        // Previous error: Threshold was 5000. Max delta is 255.
        // New logic: Delta of 10 is subtle, 50 is huge.
        const delta = Math.abs(avg - lastLight);
        
        if(curMod==='intruder') document.getElementById('live-data').innerText = `MOTION: ${delta} / LIGHT: ${avg}`;
        
        // Threshold: High Sens (90) -> thresh 3. Low Sens (10) -> thresh 40.
        const intThresh = (100 - mods.intruder.sens) * 0.4;
        
        if(mods.intruder.armed && delta > intThresh && delta > 2) { 
             // delta > 2 prevents noise
             trigger('intruder');
        }

        // 3. LUMEN LOGIC (Fixed Logic)
        if(mods.lumen.armed && mods.lumen.ready) {
            // High Sens (90) -> Trigger at brightness 20
            // Low Sens (10) -> Trigger at brightness 180
            const lumThresh = 200 - (mods.lumen.sens * 1.8);
            if(avg > lumThresh) trigger('lumen');
        }

        lastLight = avg;
    }

    window.addEventListener('devicemotion', e => {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        if(!accBase) accBase = acc;
        
        // 4. SEISMIC LOGIC (Fixed Sensitivity)
        // Old threshold was ~1.5. New needs to be ~0.1
        const diff = Math.abs(acc.x-accBase.x) + Math.abs(acc.y-accBase.y);
        
        if(curMod==='seismic') document.getElementById('live-data').innerText = "VIB: "+diff.toFixed(3);
        
        // Sens 100 -> Thresh 0.05. Sens 1 -> Thresh 1.0
        const seisT = (100 - mods.seismic.sens) / 100 + 0.05;
        
        if(mods.seismic.armed && diff > seisT) trigger('seismic');

        // Drift correction for seismic (Slowly adapt to new angle)
        accBase.x += (acc.x - accBase.x) * 0.05;
        accBase.y += (acc.y - accBase.y) * 0.05;
    });

    // --- ALERT SYSTEM ---
    function trigger(key) {
        if(document.getElementById('card-'+key).classList.contains('alert')) return;
        
        // Visual
        const card = document.getElementById('card-'+key);
        card.classList.add('alert');
        setTimeout(()=>card.classList.remove('alert'), 3000);
        
        // Log
        logs.push(`[${new Date().toLocaleTimeString()}] ${mods[key].name} TRIGGERED`);

        // Strobe
        if(key === 'intruder' && mods.intruder.strobe) {
            const s = document.getElementById('strobe-layer');
            s.style.display='block'; s.style.animation='strobe 0.1s infinite';
            setTimeout(()=>{ s.style.display='none'; s.style.animation='none'; }, 5000);
        }

        playSiren();
    }

    function playSiren() {
        if(!audioCtx) return;
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value=800; o.start(); o.stop(audioCtx.currentTime+0.5);
    }

    function panic() { alert("PANIC BEACON BROADCASTING"); }

    function downloadLogs() {
        const b = new Blob([logs.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download='vanguard_logs.txt';
        a.click();
    }
</script>
</body>
</html>
