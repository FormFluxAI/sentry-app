<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Safety App</title>
    <style>
        :root { --primary: #ff4444; --dark: #1a1a1a; --light: #f4f4f4; }
        body { font-family: sans-serif; background: var(--dark); color: var(--light); text-align: center; margin: 0; padding: 20px; }
        
        /* Dashboard Grid */
        .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        
        /* Video Window */
        .cam-wrapper { position: relative; border: 2px solid #333; border-radius: 12px; overflow: hidden; background: #000; height: 300px; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; display: none; }
        .recording-dot { width: 10px; height: 10px; background: red; border-radius: 50%; display: inline-block; animation: pulse 1s infinite; margin-right: 5px; }

        /* Controls */
        .btn { border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-arm { background: #2196F3; color: white; }
        .btn-arm.armed { background: #4CAF50; }
        .btn-panic { background: var(--primary); color: white; height: 80px; font-size: 1.5rem; text-transform: uppercase; box-shadow: 0 4px 15px rgba(255, 68, 68, 0.4); }
        .btn-panic:active { transform: scale(0.98); }
        
        /* Settings Area */
        .settings-panel { background: #333; padding: 15px; border-radius: 8px; text-align: left; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* Panic Mode Animation */
        .panic-mode { animation: flashRed 0.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes flashRed { 0%, 100% { background: var(--dark); } 50% { background: #500000; } }

        /* Hidden canvas for processing */
        #motionCanvas { display: none; }
    </style>
</head>
<body id="mainBody">

<div class="container">
    <h2>üõ°Ô∏è Sentinel Safety</h2>

    <div class="cam-wrapper">
        <video id="webcam" autoplay playsinline muted></video>
        <div id="statusBadge" class="status-badge"><span class="recording-dot"></span> RECORDING</div>
        <p id="camPlaceholder">Camera Off</p>
    </div>

    <button id="permBtn" class="btn" style="background: #555; color: white;">1. Grant Permissions</button>
    <button id="armBtn" class="btn btn-arm" disabled>2. Arm Motion Detector</button>
    
    <button id="panicBtn" class="btn btn-panic">üÜò PANIC BUTTON</button>

    <div class="settings-panel">
        <div class="toggle-row">
            <span>Sound Alarm on Motion?</span>
            <input type="checkbox" id="alarmToggle" checked>
        </div>
        <div class="toggle-row">
            <span>Record Video on Motion?</span>
            <input type="checkbox" id="recordToggle" checked>
        </div>
        <div id="locationDisplay" style="font-size: 0.8rem; color: #aaa; margin-top: 10px;">Location: Unknown</div>
    </div>
</div>

<canvas id="motionCanvas"></canvas>

<script>
    // --- VARIABLES ---
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('motionCanvas');
    const ctx = canvas.getContext('2d');
    const armBtn = document.getElementById('armBtn');
    const permBtn = document.getElementById('permBtn');
    const statusBadge = document.getElementById('statusBadge');
    const camPlaceholder = document.getElementById('camPlaceholder');
    const locationDisplay = document.getElementById('locationDisplay');
    
    let isArmed = false;
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let motionInterval = null;
    let previousFrame = null;
    let isRecording = false;

    // Siren Audio Context
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // --- 1. PERMISSIONS & SETUP ---
    permBtn.addEventListener('click', async () => {
        try {
            // Request Camera & Mic
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            video.srcObject = stream;
            camPlaceholder.style.display = 'none';
            
            // Enable Arm Button
            permBtn.style.display = 'none';
            armBtn.disabled = false;
            armBtn.innerText = "Arm Motion Detector";
            
            // Get Location
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    locationDisplay.innerText = `Location: ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                });
            }
            
            setupRecorder();
        } catch (err) {
            alert("Error: Could not access camera/mic. Please allow permissions in browser settings.");
            console.error(err);
        }
    });

    function setupRecorder() {
        if (!stream) return;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            recordedChunks = [];
            const url = URL.createObjectURL(blob);
            // Auto-download the video (or upload in a real app)
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_footage_${new Date().toISOString()}.webm`;
            a.click();
        };
    }

    // --- 2. MOTION DETECTION LOGIC ---
    armBtn.addEventListener('click', () => {
        isArmed = !isArmed;
        if (isArmed) {
            armBtn.classList.add('armed');
            armBtn.innerText = "SYSTEM ARMED (Detecting...)";
            startMotionDetection();
        } else {
            armBtn.classList.remove('armed');
            armBtn.innerText = "Arm Motion Detector";
            stopMotionDetection();
            stopRecording();
        }
    });

    function startMotionDetection() {
        canvas.width = 100; // Low res for performance
        canvas.height = 100;
        
        motionInterval = setInterval(() => {
            if (!isArmed) return;
            
            ctx.drawImage(video, 0, 0, 100, 100);
            const currentFrame = ctx.getImageData(0, 0, 100, 100);
            
            if (previousFrame) {
                const diff = calculatePixelDiff(previousFrame, currentFrame);
                if (diff > 2000) { // Threshold for motion
                    triggerSecurityEvent();
                }
            }
            previousFrame = currentFrame;
        }, 500); // Check every 500ms
    }

    function stopMotionDetection() {
        clearInterval(motionInterval);
        previousFrame = null;
    }

    function calculatePixelDiff(img1, img2) {
        let diff = 0;
        for (let i = 0; i < img1.data.length; i += 4) {
            diff += Math.abs(img1.data[i] - img2.data[i]); // Check R channel changes
        }
        return diff;
    }

    // --- 3. SECURITY EVENT (ALARM/RECORD) ---
    function triggerSecurityEvent() {
        if (document.getElementById('recordToggle').checked && !isRecording) {
            startRecording();
        }
        if (document.getElementById('alarmToggle').checked) {
            playBeep(); // Short beep for motion
        }
    }

    function startRecording() {
        isRecording = true;
        statusBadge.style.display = 'block';
        mediaRecorder.start();
        
        // Record for 10 seconds then stop
        setTimeout(() => {
            stopRecording();
        }, 10000);
    }

    function stopRecording() {
        if (isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            statusBadge.style.display = 'none';
        }
    }

    // --- 4. PANIC BUTTON ---
    const panicBtn = document.getElementById('panicBtn');
    let panicInterval;
    let isPanic = false;

    panicBtn.addEventListener('click', () => {
        isPanic = !isPanic;
        if (isPanic) {
            document.body.classList.add('panic-mode');
            panicBtn.innerText = "STOP ALARM";
            playSiren();
        } else {
            document.body.classList.remove('panic-mode');
            panicBtn.innerText = "üÜò PANIC BUTTON";
            stopSiren();
        }
    });

    // --- AUDIO UTILS (Siren/Beep) ---
    let oscillator = null;
    
    function playSiren() {
        // Create a wailing siren sound
        if (audioCtx.state === 'suspended') audioCtx.resume();
        oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
        oscillator.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 0.5); // Ramp up
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        
        // Loop the frequency ramp
        panicInterval = setInterval(() => {
            const now = audioCtx.currentTime;
            oscillator.frequency.setValueAtTime(500, now);
            oscillator.frequency.linearRampToValueAtTime(1000, now + 0.5);
        }, 500);
    }

    function stopSiren() {
        if (oscillator) {
            oscillator.stop();
            oscillator = null;
        }
        clearInterval(panicInterval);
    }

    function playBeep() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = 800;
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }
</script>

</body>
</html>
