<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sentinel Ultimate</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #00ff41;
            --neon-red: #ff003c;
            --bg-dark: #050505;
            --panel-bg: #111;
            --text-main: #eee;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            font-family: 'Courier New', Courier, monospace; /* Cyberpunk aesthetic */
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- UI FRAMEWORK --- */
        header {
            border-bottom: 2px solid #333; padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8);
        }
        h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: var(--neon-blue); text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); }

        /* Main Scroll Area */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* Module Cards */
        .module {
            background: var(--panel-bg); border: 1px solid #333;
            border-radius: 8px; margin-bottom: 20px; padding: 15px;
            position: relative; transition: 0.3s;
        }
        .module.active { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(0, 255, 65, 0.1); }
        .module.alert { border-color: var(--neon-red); animation: pulseRed 0.5s infinite; }

        .mod-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mod-title { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        /* Control Buttons */
        .btn {
            background: #222; color: #aaa; border: 1px solid #444;
            padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; flex: 1;
        }
        .btn-arm { background: #003300; color: var(--neon-green); border-color: var(--neon-green); }
        .btn-arm.armed { background: var(--neon-green); color: black; box-shadow: 0 0 10px var(--neon-green); }
        
        .row-btn { display: flex; gap: 10px; margin-top: 10px; }

        /* --- VISUALIZERS --- */
        .hidden-cam { width: 100px; height: 100px; position: fixed; top: -1000px; } /* Kept off screen for stealth */
        .preview-cam { width: 100%; height: 200px; background: #000; object-fit: cover; border-radius: 4px; border: 1px solid #333; }
        
        .meter-container { height: 10px; background: #222; width: 100%; margin: 10px 0; border-radius: 5px; overflow: hidden; }
        .meter-fill { height: 100%; width: 0%; background: var(--neon-blue); transition: width 0.1s; }
        .meter-fill.danger { background: var(--neon-red); }

        /* --- FOOTER PANIC --- */
        .panic-dock {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 80px; background: #000; border-top: 2px solid var(--neon-red);
            display: flex; justify-content: center; align-items: center;
            z-index: 99;
        }
        .panic-btn {
            width: 90%; height: 60px; background: var(--neon-red); color: white;
            border: none; font-size: 1.5rem; font-weight: 900; letter-spacing: 3px;
            text-transform: uppercase; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
            box-shadow: 0 0 20px rgba(255, 0, 60, 0.4);
            animation: breathe 2s infinite;
        }

        /* --- STEALTH OVERLAY (Fake Sleep) --- */
        #stealthOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; display: none; cursor: none;
        }
        
        /* --- LOGS --- */
        .log-entry { font-size: 0.8rem; border-bottom: 1px solid #333; padding: 8px 0; color: #ccc; }
        .log-entry img { display: block; margin-top: 5px; width: 100px; border: 1px solid #555; }
        .log-timestamp { color: var(--neon-blue); margin-right: 10px; }

        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 60, 0); } }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    </style>
</head>
<body>

<header>
    <h1>Sentinel <span style="font-size:0.8em; color:#666;">ULTIMATE</span></h1>
    <button class="btn" style="width: auto; padding: 5px 10px;" onclick="toggleStealth()">ðŸŒ‘ STEALTH</button>
</header>

<main>
    <div class="module" id="mod-snooper">
        <div class="mod-header">
            <div class="mod-title"><i class="material-icons">touch_app</i> SNOOPER TRAP</div>
            <div style="font-size:0.7rem; color:#888;">STATUS: <span id="snooperStatus">OFFLINE</span></div>
        </div>
        <p style="font-size: 0.8rem; color:#aaa;">If device is moved/grabbed, it silently snaps a selfie and logs the event.</p>
        
        <div class="row-btn">
            <button class="btn btn-arm" id="btn-snooper" onclick="toggleSnooper()">ARM TRAP</button>
        </div>
    </div>

    <div class="module" id="mod-audio">
        <div class="mod-header">
            <div class="mod-title"><i class="material-icons">graphic_eq</i> IMPULSE DETECT</div>
            <div style="font-size:0.7rem; color:#888;" id="db-readout">0 dB</div>
        </div>
        <div class="meter-container"><div class="meter-fill" id="audioMeter"></div></div>
        <p style="font-size: 0.8rem; color:#aaa;">Detects sudden high-decibel spikes (Gunshots, Glass Break, Screams).</p>
        
        <div class="row-btn">
            <button class="btn btn-arm" id="btn-audio" onclick="toggleAudioSentinel()">ARM SENSOR</button>
        </div>
    </div>

    <div class="module" id="mod-video">
        <div class="mod-header">
            <div class="mod-title"><i class="material-icons">videocam</i> VISUAL SENTRY</div>
        </div>
        <video id="mainCam" class="preview-cam" autoplay playsinline muted></video>
        
        <div class="row-btn">
            <button class="btn btn-arm" id="btn-video" onclick="toggleVideoSentry()">ARM CAMERA</button>
        </div>
    </div>

    <div class="module">
        <div class="mod-header">
            <div class="mod-title"><i class="material-icons">folder_shared</i> EVIDENCE LOG</div>
            <button class="btn" style="width: auto; font-size: 0.7rem;" onclick="downloadLogs()">ðŸ’¾ DOWNLOAD ALL</button>
        </div>
        <div id="logFeed" style="max-height: 200px; overflow-y: auto;">
            <div class="log-entry">System ready...</div>
        </div>
    </div>
</main>

<div class="panic-dock">
    <button class="panic-btn" onclick="triggerPanic()">PANIC</button>
</div>

<canvas id="procCanvas" style="display:none;"></canvas>
<div id="stealthOverlay" onclick="exitStealth()"><div style="position:absolute; bottom:20px; width:100%; text-align:center; color:#111;">Tap 1234 to unlock</div></div>

<script>
    // --- CORE SYSTEM ---
    const logs = [];
    const videoEl = document.getElementById('mainCam');
    const canvas = document.getElementById('procCanvas');
    const ctx = canvas.getContext('2d');
    let stream = null;
    
    // --- STATE FLAGS ---
    let state = {
        snooper: false,
        audio: false,
        video: false,
        panic: false
    };

    // --- INITIALIZATION ---
    async function init() {
        try {
            // Request Cam/Mic/Sensors
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            videoEl.srcObject = stream;
            
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                await DeviceMotionEvent.requestPermission();
            }
            
            initAudioAnalysis();
            startMotionLoops();
            log("System", "All sensors initialized.");
        } catch (e) {
            alert("Permissions required for Sentinel to work.");
            console.error(e);
        }
    }
    
    // Auto-init on first interaction to bypass browser blocks
    document.body.addEventListener('click', () => {
        if (!stream) init();
    }, { once: true });


    // --- 1. SNOOPER TRAP (Accelerometer) ---
    let lastAccel = { x:0, y:0, z:0 };
    
    function toggleSnooper() {
        state.snooper = !state.snooper;
        updateBtn('btn-snooper', state.snooper);
        document.getElementById('snooperStatus').innerText = state.snooper ? "ARMED" : "OFFLINE";
        if(state.snooper) log("Snooper", "Trap Armed. Do not move device.");
    }

    window.addEventListener('devicemotion', (e) => {
        if (!state.snooper) {
            lastAccel = e.accelerationIncludingGravity; // Sync
            return;
        }

        const acc = e.accelerationIncludingGravity;
        const delta = Math.abs(acc.x - lastAccel.x) + Math.abs(acc.y - lastAccel.y) + Math.abs(acc.z - lastAccel.z);
        
        // Threshold for "Pick Up"
        if (delta > 3) { 
            triggerSnooperEvent();
        }
        lastAccel = acc;
    });

    function triggerSnooperEvent() {
        // Debounce to prevent 100 selfies in 1 second
        if (document.getElementById('mod-snooper').classList.contains('alert')) return;
        
        flashModule('mod-snooper');
        takeEvidencePhoto("Snooper Trap Triggered (Device Moved)");
        playShutterSound();
    }


    // --- 2. AUDIO SENTINEL (Gunshot/Impulse) ---
    let audioCtx, analyser, dataArray;
    
    function initAudioAnalysis() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        loopAudio();
    }

    function toggleAudioSentinel() {
        state.audio = !state.audio;
        updateBtn('btn-audio', state.audio);
        if(state.audio) audioCtx.resume();
    }

    function loopAudio() {
        requestAnimationFrame(loopAudio);
        if (!analyser) return;
        
        analyser.getByteFrequencyData(dataArray);
        const avgVol = dataArray.reduce((a,b)=>a+b) / dataArray.length;
        
        // Visualizer
        const meter = document.getElementById('audioMeter');
        meter.style.width = (avgVol / 255 * 100) + "%";
        document.getElementById('db-readout').innerText = Math.round(avgVol) + " units";

        // Logic: Gunshots are SUDDEN spikes.
        // If volume jumps from <50 to >150 instantly -> Trigger
        if (state.audio && avgVol > 180) {
            meter.classList.add('danger');
            triggerAudioEvent("High Impulse Noise Detected (Potential Gunshot/Crash)");
        } else {
            meter.classList.remove('danger');
        }
    }

    function triggerAudioEvent(msg) {
        if (document.getElementById('mod-audio').classList.contains('alert')) return;
        flashModule('mod-audio');
        log("Audio", msg);
        // Start recording audio logic here (simplified for this demo)
    }


    // --- 3. VIDEO SENTRY (Motion) ---
    function toggleVideoSentry() {
        state.video = !state.video;
        updateBtn('btn-video', state.video);
    }

    function startMotionLoops() {
        // Check video motion every 500ms
        setInterval(() => {
            if (!state.video) return;
            
            canvas.width = 100; canvas.height = 100;
            ctx.drawImage(videoEl, 0, 0, 100, 100);
            const frame = ctx.getImageData(0,0,100,100);
            
            // Simplified motion logic (Brightness change)
            // Real apps use pixel diff, but brightness is faster for web
            let brightness = 0;
            for(let i=0; i<frame.data.length; i+=4) brightness += frame.data[i];
            brightness = brightness / (frame.data.length/4);
            
            // We need previous frame state, simplistic approach here:
            if (window.lastBrightness && Math.abs(brightness - window.lastBrightness) > 20) {
                triggerVideoEvent();
            }
            window.lastBrightness = brightness;

        }, 500);
    }

    function triggerVideoEvent() {
        if (document.getElementById('mod-video').classList.contains('alert')) return;
        flashModule('mod-video');
        takeEvidencePhoto("Visual Motion Detected");
    }


    // --- SHARED UTILS ---
    function takeEvidencePhoto(reason) {
        canvas.width = videoEl.videoWidth;
        canvas.height = videoEl.videoHeight;
        ctx.drawImage(videoEl, 0, 0);
        const imgData = canvas.toDataURL('image/jpeg');
        log("Evidence", reason, imgData);
    }

    function log(module, msg, imgData = null) {
        const time = new Date().toLocaleTimeString();
        const entry = { time, module, msg, imgData };
        logs.push(entry);
        
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-timestamp">[${time}]</span> <strong>${module}:</strong> ${msg}`;
        if (imgData) {
            div.innerHTML += `<img src="${imgData}">`;
        }
        document.getElementById('logFeed').prepend(div);
    }

    function flashModule(id) {
        const el = document.getElementById(id);
        el.classList.add('alert');
        setTimeout(() => el.classList.remove('alert'), 2000);
    }

    function updateBtn(id, active) {
        const btn = document.getElementById(id);
        if (active) {
            btn.classList.add('armed');
            btn.innerText = "ARMED (STOP)";
        } else {
            btn.classList.remove('armed');
            btn.innerText = "ARM SENSOR";
        }
    }

    function playShutterSound() {
        // Tiny distinct click
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = 1200;
        o.start(); o.stop(audioCtx.currentTime + 0.05);
    }


    // --- PANIC & EXPORT ---
    function triggerPanic() {
        state.panic = !state.panic;
        const btn = document.querySelector('.panic-btn');
        if (state.panic) {
            btn.innerText = "STOP ALARM";
            btn.style.background = "white";
            btn.style.color = "red";
            startSiren();
            log("Panic", "Panic Button Activated Manually");
        } else {
            btn.innerText = "PANIC";
            btn.style.background = "var(--neon-red)";
            btn.style.color = "white";
            stopSiren();
        }
    }

    let sirenOsc;
    function startSiren() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        sirenOsc = audioCtx.createOscillator();
        sirenOsc.type = 'sawtooth';
        sirenOsc.connect(audioCtx.destination);
        sirenOsc.start();
        // Wailing effect
        const now = audioCtx.currentTime;
        sirenOsc.frequency.setValueAtTime(600, now);
        sirenOsc.frequency.linearRampToValueAtTime(1200, now + 0.5);
        sirenOsc.frequency.linearRampToValueAtTime(600, now + 1.0);
        // In real use, use setInterval for continuous wail
    }
    function stopSiren() {
        if(sirenOsc) { sirenOsc.stop(); sirenOsc = null; }
    }

    function downloadLogs() {
        let content = "SENTINEL SECURITY LOG\nGenerated: " + new Date().toLocaleString() + "\n\n";
        logs.forEach(l => {
            content += `[${l.time}] ${l.module}: ${l.msg}\n`;
        });
        
        // Text Log Download
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sentinel_logs.txt';
        a.click();
        
        // If there are images, we ideally zip them, but for a single file demo:
        // We will just open the last image in a new tab
        const lastImg = logs.find(l => l.imgData);
        if(lastImg) {
            const win = window.open();
            win.document.write('<img src="' + lastImg.imgData + '">');
        } else {
            alert("Logs downloaded. No images captured yet.");
        }
    }

    // --- STEALTH MODE ---
    let stealthClicks = 0;
    function toggleStealth() {
        document.getElementById('stealthOverlay').style.display = 'block';
        log("System", "Entered Stealth Mode");
    }
    function exitStealth() {
        // Simple tap 3 times to exit for this demo
        stealthClicks++;
        if (stealthClicks >= 3) {
            document.getElementById('stealthOverlay').style.display = 'none';
            stealthClicks = 0;
        } else {
            // Fake error
            navigator.vibrate(50);
        }
    }
</script>
</body>
</html>
