<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENTRY 3.0</title>
    <style>
        :root { --bg: #000; --safe: #00ff41; --danger: #ff0000; --warn: #ffaa00; }
        body { background-color: var(--bg); color: #fff; font-family: monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; user-select: none; -webkit-user-select: none; }
        
        /* ALARM STROBE */
        @keyframes strobe { 0% { background: #fff; } 50% { background: var(--danger); } 100% { background: #fff; } }
        body.alarm-active { animation: strobe 0.1s infinite; }
        body.alarm-active * { display: none !important; }
        body.alarm-active::after { content: 'BREACH DETECTED'; color: #000; font-size: 3rem; font-weight: 900; position: absolute; top: 40%; left: 0; width: 100%; text-align: center; }

        h1 { margin: 0; font-size: 2.5rem; letter-spacing: 5px; color: var(--safe); margin-bottom: 5px; }
        .version { color: #666; font-size: 0.8rem; margin-bottom: 20px; border: 1px solid #333; padding: 5px 10px; border-radius: 20px; }
        
        /* HUD GRID */
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 350px; margin-bottom: 30px; }
        .sensor-box { border: 1px solid #333; padding: 15px; text-align: center; border-radius: 8px; background: #111; transition: 0.2s; }
        .sensor-box.active { border-color: var(--safe); background: #003300; box-shadow: 0 0 15px rgba(0, 255, 65, 0.2); }
        .sensor-label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; }
        .sensor-val { font-size: 1.2rem; font-weight: bold; color: #fff; }

        /* ARM BUTTON */
        .arm-btn {
            width: 200px; height: 200px; border-radius: 50%;
            border: 4px solid var(--safe); background: rgba(0, 255, 65, 0.1);
            color: var(--safe); font-size: 1.5rem; font-weight: 900; letter-spacing: 3px;
            cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; text-align: center;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
            margin-bottom: 30px;
        }
        .arm-btn:active { transform: scale(0.95); }
        .arm-btn.armed { border-color: var(--danger); color: var(--danger); background: rgba(255, 0, 0, 0.1); animation: pulse-red 2s infinite; }
        .arm-btn.counting { border-color: var(--warn); color: var(--warn); background: rgba(255,170,0,0.1); }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* DEBUG CONSOLE (To see errors) */
        .console-log { width: 100%; max-width: 350px; height: 100px; overflow-y: scroll; background: #111; border: 1px solid #333; font-size: 0.7rem; padding: 10px; box-sizing: border-box; color: #aaa; text-align: left; margin-top: 20px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; }

        #stop-hint { display:none; position:fixed; bottom:50px; width:100%; text-align:center; color:#000; font-weight:bold; z-index:999; }
    </style>
</head>
<body>

    <h1>SENTRY</h1>
    <div class="version">v3.0 - FUSION CORE</div>

    <div class="hud-grid">
        <div class="sensor-box" id="box-motion">
            <span class="sensor-label">VIBRATION</span>
            <span class="sensor-val" id="val-motion">0.0</span>
        </div>
        <div class="sensor-box" id="box-audio">
            <span class="sensor-label">AUDIO LEVEL</span>
            <span class="sensor-val" id="val-audio">OFF</span>
        </div>
    </div>

    <div class="arm-btn" id="main-btn" onclick="handleButton()">
        ARM<br>SYSTEM
    </div>

    <div class="console-log" id="console">
        <div class="log-entry">> SYSTEM BOOT v3.0...</div>
        <div class="log-entry">> WAITING FOR USER INPUT...</div>
    </div>

    <div id="stop-hint">TAP SCREEN TO DISARM</div>

    <script>
        // --- CONFIG ---
        let state = 'IDLE'; 
        let lastX=null, lastY=null, lastZ=null;
        let micStream, analyser, dataArray, audioCtx;

        function log(msg) {
            const consoleBox = document.getElementById('console');
            consoleBox.innerHTML += `<div class="log-entry">> ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // --- CORE CONTROL ---
        function handleButton() {
            if(state === 'IDLE') initSensors();
            else if(state === 'ARMED' || state === 'COUNTDOWN') disarm();
        }

        async function initSensors() {
            log("INITIALIZING SENSORS...");
            
            // 1. REQUEST MICROPHONE
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log("MICROPHONE ACCESS: GRANTED");
                setupAudioMonitor();
            } catch(e) {
                log("MICROPHONE ERROR: " + e.message);
                log("Make sure you click ALLOW on popup");
                alert("Microphone blocked! Check site settings.");
            }

            // 2. REQUEST MOTION (iOS only needs this, Android is auto)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(resp => { 
                        log("MOTION PERMISSION: " + resp);
                        if (resp === 'granted') startCountdown(); 
                    })
                    .catch(e => log("MOTION ERROR: " + e));
            } else {
                startCountdown();
            }
        }

        function startCountdown() {
            state = 'COUNTDOWN';
            const btn = document.getElementById('main-btn');
            btn.classList.add('counting');
            let count = 5;
            
            const timer = setInterval(() => {
                count--;
                btn.innerHTML = count;
                if(count <= 0) {
                    clearInterval(timer);
                    armSystem();
                }
            }, 1000);
        }

        function armSystem() {
            state = 'ARMED';
            const btn = document.getElementById('main-btn');
            btn.classList.remove('counting');
            btn.classList.add('armed');
            btn.innerHTML = "SYSTEM<br>ARMED";
            log("SYSTEM ARMED - MONITORING...");
            
            lastX = null;
            window.addEventListener('devicemotion', handleMotion);
            if(micStream) analyzeAudioLoop();
        }

        // --- MOTION LOGIC ---
        function handleMotion(event) {
            if(state !== 'ARMED') return;
            const acc = event.accelerationIncludingGravity;
            if(!acc) return;

            const x = acc.x; const y = acc.y; const z = acc.z;
            if(lastX === null) { lastX=x; lastY=y; lastZ=z; return; }

            const delta = Math.abs(x-lastX) + Math.abs(y-lastY) + Math.abs(z-lastZ);
            
            document.getElementById('val-motion').innerText = delta.toFixed(1);
            if(delta > 0.5) document.getElementById('box-motion').classList.add('active');
            else document.getElementById('box-motion').classList.remove('active');

            if(delta > 8.0) { // Threshold for motion
                log("TRIGGER: MOTION SPIKE (" + delta.toFixed(1) + ")");
                triggerAlarm();
            }

            lastX=x; lastY=y; lastZ=z;
        }

        // --- AUDIO LOGIC ---
        function setupAudioMonitor() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext(); // Re-use for siren
            analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaStreamSource(micStream);
            src.connect(analyser);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function analyzeAudioLoop() {
            if(state !== 'ARMED') return;
            requestAnimationFrame(analyzeAudioLoop);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            const avg = Math.floor(sum / dataArray.length);

            document.getElementById('val-audio').innerText = avg;
            if(avg > 10) document.getElementById('box-audio').classList.add('active');
            else document.getElementById('box-audio').classList.remove('active');

            if(avg > 40) { // Threshold for sound
                log("TRIGGER: AUDIO SPIKE (" + avg + ")");
                triggerAlarm();
            }
        }

        // --- ALARM ---
        function triggerAlarm() {
            if(state === 'ALARM') return;
            state = 'ALARM';
            
            // Stop Listeners
            window.removeEventListener('devicemotion', handleMotion);
            
            // UI
            document.body.classList.add('alarm-active');
            document.getElementById('stop-hint').style.display = 'block';
            
            // Siren
            playSiren();
            
            document.body.onclick = disarm;
        }

        function playSiren() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(900, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1400, audioCtx.currentTime + 0.1);
            gain.gain.value = 1.0;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
            setTimeout(() => { if(state === 'ALARM') playSiren(); }, 500);
        }

        function disarm() {
            state = 'IDLE';
            window.removeEventListener('devicemotion', handleMotion);
            document.body.classList.remove('alarm-active');
            document.getElementById('stop-hint').style.display = 'none';
            document.body.onclick = null;
            
            const btn = document.getElementById('main-btn');
            btn.classList.remove('armed'); 
            btn.classList.remove('counting');
            btn.innerHTML = "ARM<br>SYSTEM";
            log("SYSTEM DISARMED");
        }
    </script>
</body>
</html>
