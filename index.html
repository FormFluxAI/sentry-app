<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECHO: ONE</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- BRANDING: MATTE BLACK & GOLD --- */
        :root {
            --gold: #FFD700;
            --gold-dim: #998100;
            --alert: #FF2A2A;
            --bg: #050505;
            --card-bg: #111111;
            --border: #333;
            --text-main: #eee;
            --text-muted: #666;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Helvetica Neue', Arial, sans-serif; }
        
        body { 
            background-color: var(--bg); 
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 70%);
            color: var(--text-main); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- 1. AUTH SCREEN --- */
        #auth-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 30px;
        }
        .auth-logo { font-size: 3rem; font-weight: 900; letter-spacing: 5px; color: var(--gold); margin-bottom: 5px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .auth-sub { color: var(--text-muted); font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 50px; text-transform: uppercase; }
        
        .social-btn {
            width: 100%; max-width: 320px; padding: 15px; margin: 10px 0; border-radius: 4px;
            border: 1px solid #333; background: #111; color: #fff; font-weight: 600; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; gap: 12px; cursor: pointer; transition: 0.2s;
        }
        .social-btn:active { transform: scale(0.98); border-color: var(--gold); }
        .social-btn.google { background: #fff; color: #000; border: none; }

        /* --- 2. HEADER --- */
        header { 
            padding: 15px 20px; background: rgba(5,5,5,0.95); border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            backdrop-filter: blur(10px);
        }
        .brand { font-size: 1.1rem; font-weight: 800; letter-spacing: 1px; color: var(--gold); display: flex; align-items: center; gap: 8px; }
        .user-pill { font-size: 0.7rem; color: #aaa; background: #222; padding: 4px 10px; border-radius: 20px; border: 1px solid #333; }

        /* --- 3. TABS --- */
        .tabs { display: flex; background: #000; border-bottom: 1px solid var(--border); }
        .tab { 
            flex: 1; padding: 15px; text-align: center; color: var(--text-muted); 
            font-size: 0.75rem; font-weight: 700; cursor: pointer; letter-spacing: 1px; 
        }
        .tab.active { color: var(--gold); border-bottom: 2px solid var(--gold); background: linear-gradient(to top, rgba(255, 215, 0, 0.05), transparent); }

        /* --- 4. SCROLL CONTENT --- */
        #main-content { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .view-section { display: none; padding: 15px; padding-bottom: 120px; /* Space for footer */ }
        .view-section.active { display: block; animation: fadeUp 0.3s ease-out; }

        /* --- 5. MODULE LIST (Refined) --- */
        .module-row {
            background: var(--card-bg); border: 1px solid var(--border); padding: 18px;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px; border-radius: 6px; position: relative; overflow: hidden;
        }
        /* Selection State */
        .module-row.selected { border-color: var(--gold-dim); background: #1a1500; }
        .module-row.selected::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--gold); }
        /* Armed State */
        .module-row.armed { border-color: #0f0; background: rgba(0,50,0,0.2); }
        .module-row.armed::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:#0f0; }
        /* Triggered */
        .module-row.triggered { border-color: var(--alert); background: rgba(50,0,0,0.4); animation: flashRed 0.5s infinite; }

        .mod-icon { font-size: 1.8rem; color: #444; width: 40px; text-align: center; }
        .module-row.selected .mod-icon { color: var(--gold); }
        .module-row.armed .mod-icon { color: #0f0; }

        .mod-info { flex: 1; margin: 0 15px; }
        .mod-title { font-weight: 700; font-size: 0.95rem; color: #eee; margin-bottom: 4px; }
        .mod-desc { font-size: 0.7rem; color: #888; }
        
        /* Checkbox Styling */
        .chk-wrap { position: relative; width: 24px; height: 24px; }
        .chk-box { 
            appearance: none; width: 100%; height: 100%; border: 2px solid #444; border-radius: 4px; background: transparent; cursor: pointer;
        }
        .chk-box:checked { background: var(--gold); border-color: var(--gold); }
        
        /* Settings Gear */
        .gear-btn { color: #444; padding: 10px; margin-right: -10px; cursor: pointer; }
        .module-row.selected .gear-btn { color: #888; }

        /* Mini Meters */
        .meter-track { height: 3px; background: #222; margin-top: 8px; position: relative; width: 100%; border-radius: 2px; }
        .meter-fill { height: 100%; width: 0%; background: var(--gold); transition: width 0.1s; }
        .meter-trig { position: absolute; top: -2px; bottom: -2px; width: 2px; background: var(--alert); z-index: 5; }

        /* --- 6. MAP & LOGS --- */
        #map-canvas { width: 100%; height: 65vh; border-radius: 6px; border: 1px solid var(--border); margin-top: 10px; }
        .log-item { 
            font-family: 'Courier New', monospace; font-size: 0.75rem; 
            border-left: 2px solid #333; padding: 8px 12px; margin-bottom: 5px; background: #0a0a0a; 
        }
        .log-item.alert { border-left-color: var(--alert); color: #ffadad; }

        /* --- 7. FOOTER CONTROLS --- */
        .control-dock {
            position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.95);
            border-top: 1px solid var(--border); padding: 15px 20px; display: flex; gap: 12px; z-index: 500;
            backdrop-filter: blur(10px);
        }
        .btn {
            flex: 1; padding: 16px; border-radius: 6px; border: none; font-weight: 800;
            font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }
        
        .btn-arm { background: var(--gold); color: #000; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); }
        .btn-disarm { background: transparent; border: 1px solid var(--alert); color: var(--alert); display: none; }
        .btn-panic { flex: 0.3; background: var(--alert); color: #fff; display: flex; align-items: center; justify-content: center; }

        /* --- 8. SETTINGS MODAL --- */
        #settings-modal {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #161616; 
            border-top: 2px solid var(--gold); padding: 25px; z-index: 2000;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 12px 12px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        #settings-modal.open { transform: translateY(0); }
        
        input[type=range] { width: 100%; margin: 20px 0; accent-color: var(--gold); background: #333; height: 4px; border-radius: 2px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }

        /* UTILS */
        video { position: fixed; top: -9999px; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes flashRed { 0%, 100% { background: rgba(50,0,0,0.5); } 50% { background: rgba(255,0,0,0.2); } }
        #strobe-fx { position: fixed; top:0; left:0; width:100%; height:100%; z-index:9000; display:none; pointer-events:none; background: #fff; }
        
        .status-badge { font-size: 0.6rem; text-transform: uppercase; color: #666; margin-top: 4px; }
        .module-row.armed .status-badge { color: #0f0; }
    </style>
</head>
<body>

    <div id="strobe-fx"></div>

    <div id="auth-view">
        <div class="auth-logo">ECHO:ONE</div>
        <div class="auth-sub">TACTICAL DEFENSE SUITE</div>
        
        <div class="social-btn google" onclick="auth.login('Google User')">
            <span style="font-weight:bold; color:#4285F4; font-size:1.2rem;">G</span> Continue with Google
        </div>
        <div class="social-btn" onclick="auth.login('Apple User')">
            <span style="font-size:1.2rem;">ï£¿</span> Continue with Apple
        </div>
        <div class="social-btn" onclick="auth.login('Guest Op')" style="background:transparent; border:none; color:#666;">
            Initialize as Guest
        </div>
    </div>

    <header>
        <div class="brand"><i class="material-icons" style="color:var(--gold)">shield</i> ECHO:ONE</div>
        <div class="user-pill" id="user-display">OFFLINE</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="nav('dashboard')">PROTOCOLS</div>
        <div class="tab" onclick="nav('map')">TAC-MAP</div>
        <div class="tab" onclick="nav('logs')">INTEL</div>
    </div>

    <div id="main-content">
        
        <div id="view-dashboard" class="view-section active">
            <div id="module-list"></div>
        </div>

        <div id="view-map" class="view-section">
            <div style="background: var(--alert); color: white; padding: 10px; text-align: center; border-radius: 4px; display: none; font-weight: bold; font-size: 0.8rem;" id="map-alert">
                <i class="material-icons" style="vertical-align: bottom; font-size: 1.1rem;">warning</i> THREAT DETECTED - EVASION VECTOR PLOTTED
            </div>
            <div id="map-canvas"></div>
        </div>

        <div id="view-logs" class="view-section">
            <button onclick="logger.download()" style="width:100%; padding:12px; background:#222; border:1px solid #333; color:var(--gold); font-weight:bold; margin-bottom:15px; border-radius:4px;">EXPORT INTEL LOG</button>
            <div id="log-container"></div>
        </div>

    </div>

    <div id="settings-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3 id="set-title" style="margin:0; color:var(--gold)">SETTINGS</h3>
            <i class="material-icons" onclick="ui.closeSettings()" style="color:#666; cursor:pointer;">close</i>
        </div>
        <div id="set-body"></div>
    </div>

    <div class="control-dock">
        <button class="btn btn-panic" onclick="alarm.panic()"><i class="material-icons">notifications_active</i></button>
        <button id="btn-arm" class="btn btn-arm" onclick="sys.arm()">ENGAGE PROTOCOLS</button>
        <button id="btn-disarm" class="btn btn-disarm" onclick="sys.disarm()">STAND DOWN</button>
    </div>

    <video id="cam" autoplay playsinline muted></video>
    <canvas id="cvs" style="display:none;"></canvas>

<script>
/** ECHO:ONE CORE LOGIC */

// 1. CONFIGURATION
const CONFIG = [
    { id: 'audio',    name: 'AUDIO SENTINEL', desc: 'Glass Break / Gunshot', icon: 'graphic_eq', thresh: 70, type: 'audio' },
    { id: 'seismic',  name: 'SEISMIC GUARD',  desc: 'Door/Floor Vibration',  icon: 'vibration',  thresh: 30, type: 'motion' },
    { id: 'lumen',    name: 'LUMEN TRAP',     desc: 'Pocket/Bag Removal',    icon: 'light_mode', thresh: 60, type: 'visual' },
    { id: 'intruder', name: 'INTRUDER CAM',   desc: 'Motion + Strobe',       icon: 'videocam',   thresh: 20, type: 'visual' },
    { id: 'snoop',    name: 'SNOOP DETECT',   desc: 'Device Handling',       icon: 'touch_app',  thresh: 15, type: 'motion' },
    { id: 'wreck',    name: 'CRASH MONITOR',  desc: 'Impact > 4G',           icon: 'car_crash',  thresh: 50, type: 'motion' },
    { id: 'velocity', name: 'VELOCITY LOCK',  desc: 'Speed > 15 MPH',        icon: 'speed',      thresh: 15, type: 'gps' },
    { id: 'geo',      name: 'PERIMETER',      desc: 'GPS Geofence (50m)',    icon: 'radar',      thresh: 50, type: 'gps' },
    { id: 'net',      name: 'NET-SENTRY',     desc: 'Anti-Jammer/Offline',   icon: 'wifi_off',   thresh: 0,  type: 'logic' },
    { id: 'deadman',  name: 'DEAD MAN',       desc: 'Safety Timer (5min)',   icon: 'timer',      thresh: 5,  type: 'logic' },
    { id: 'mag',      name: 'MAG-FIELD',      desc: 'Metal Detection',       icon: 'explore',    thresh: 60, type: 'mag' }
];

const state = {
    modules: {},
    values: {},
    base: {}
};

// Initialize State
CONFIG.forEach(m => {
    state.modules[m.id] = { selected: false, active: false, thresh: m.thresh };
    state.values[m.id] = 0;
});

// --- AUTH ---
const auth = {
    login: (user) => {
        document.getElementById('user-display').innerText = user;
        document.getElementById('auth-view').style.opacity = 0;
        setTimeout(() => {
            document.getElementById('auth-view').style.display = 'none';
            sys.initHardware();
        }, 500);
    }
};

// --- SYSTEM ---
const sys = {
    ctx: null, stream: null, analyser: null, map: null, userMark: null, lastLight: 0,

    initHardware: async () => {
        ui.render();
        
        try {
            // Audio Context
            sys.ctx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Camera (Robust)
            try {
                sys.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
            } catch(e) {
                sys.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            }
            document.getElementById('cam').srcObject = sys.stream;

            // Audio Analysis
            sys.analyser = sys.ctx.createAnalyser();
            const src = sys.ctx.createMediaStreamSource(sys.stream);
            src.connect(sys.analyser);

            // Sensors
            if(typeof DeviceMotionEvent.requestPermission === 'function') await DeviceMotionEvent.requestPermission();
            
            // Map
            mapLogic.init();

            // Loops
            requestAnimationFrame(sys.visualLoop);
            window.addEventListener('devicemotion', sys.motionLoop);
            navigator.geolocation.watchPosition(mapLogic.update, null, {enableHighAccuracy:true});
            window.addEventListener('offline', () => { if(state.modules.net.active) alarm.trigger('net'); });

        } catch(e) { console.log(e); }
    },

    arm: () => {
        let activeCount = 0;
        CONFIG.forEach(m => {
            if(state.modules[m.id].selected) {
                state.modules[m.id].active = true;
                activeCount++;
                
                // Baselines
                if(m.id === 'seismic') state.base.acc = null;
                if(m.id === 'geo') state.base.geoStart = mapLogic.lastPos;
                if(m.id === 'deadman') sys.startTimer(state.modules.deadman.thresh);
                if(m.id === 'lumen') setTimeout(() => state.modules.lumen.ready = true, 3000);
            }
        });

        if(activeCount === 0) return alert("SELECT PROTOCOLS FIRST");

        if(sys.ctx.state === 'suspended') sys.ctx.resume();
        document.getElementById('btn-arm').style.display = 'none';
        document.getElementById('btn-disarm').style.display = 'block';
        ui.render();
    },

    disarm: () => {
        CONFIG.forEach(m => state.modules[m.id].active = false);
        document.getElementById('btn-arm').style.display = 'block';
        document.getElementById('btn-disarm').style.display = 'none';
        alarm.stopStrobe();
        ui.render();
    },

    startTimer: (mins) => {
        let sec = mins * 60;
        const int = setInterval(() => {
            if(!state.modules.deadman.active) clearInterval(int);
            sec--;
            if(sec <= 0) { alarm.trigger('deadman'); clearInterval(int); }
        }, 1000);
    },

    // --- SENSOR LOOPS ---
    visualLoop: () => {
        requestAnimationFrame(sys.visualLoop);
        if(!sys.stream) return;

        // 1. Video (Optimized for Android)
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const vid = document.getElementById('cam');

        if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
            cvs.width = 40; cvs.height = 40;
            ctx.drawImage(vid, 0, 0, 40, 40);
            const data = ctx.getImageData(0,0,40,40).data;
            
            let total = 0;
            for(let i=0; i<data.length; i+=4) total += data[i];
            const avg = Math.floor(total / 1600); // 0-255

            // BOOSTED SENSITIVITY VISUALS
            state.values.lumen = (avg/255)*100;
            
            // Delta calculation for intruder
            const delta = Math.abs(avg - sys.lastLight);
            state.values.intruder = Math.min(delta * 10, 100); // Multiplier to make bar move more

            if(state.modules.lumen.active && state.modules.lumen.ready && state.values.lumen > state.modules.lumen.thresh) alarm.trigger('lumen');
            if(state.modules.intruder.active && state.values.intruder > state.modules.intruder.thresh) alarm.trigger('intruder');

            sys.lastLight = avg;
        }

        // 2. Audio
        if(sys.analyser) {
            const arr = new Uint8Array(sys.analyser.frequencyBinCount);
            sys.analyser.getByteFrequencyData(arr);
            const vol = arr.reduce((a,b)=>a+b)/arr.length;
            state.values.audio = (vol/255)*100;

            if(state.modules.audio.active && state.values.audio > state.modules.audio.thresh) {
                alarm.trigger('audio');
                mapLogic.plotEvasion();
            }
        }
        
        ui.updateMeters();
    },

    motionLoop: (e) => {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        if(!state.base.acc) state.base.acc = acc;

        const diff = Math.abs(acc.x - state.base.acc.x) + Math.abs(acc.y - state.base.acc.y);
        const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;

        state.values.seismic = Math.min(diff * 50, 100); // Scale up small vibes
        state.values.snoop = Math.min(diff * 20, 100);
        state.values.wreck = ((g-1)/4)*100;

        if(state.modules.seismic.active && state.values.seismic > state.modules.seismic.thresh) alarm.trigger('seismic');
        if(state.modules.snoop.active && state.values.snoop > state.modules.snoop.thresh) alarm.trigger('snoop');
        if(state.modules.wreck.active && state.values.wreck > state.modules.wreck.thresh) alarm.trigger('wreck');

        // Drift
        state.base.acc.x += (acc.x - state.base.acc.x) * 0.05;
        state.base.acc.y += (acc.y - state.base.acc.y) * 0.05;
    }
};

// --- MAP ---
const mapLogic = {
    init: () => {
        try {
            sys.map = L.map('map-canvas').setView([0,0], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(sys.map);
            sys.userMark = L.circleMarker([0,0], {color: '#00f3ff'}).addTo(sys.map);
        } catch(e){}
    },
    update: (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        mapLogic.lastPos = [lat, lng];
        const speed = (pos.coords.speed || 0) * 2.237;

        if(sys.map) {
            sys.userMark.setLatLng([lat, lng]);
            if(!sys.threatMark) sys.map.setView([lat, lng], 15);
        }

        state.values.velocity = speed;
        if(state.modules.velocity.active && speed > state.modules.velocity.thresh) alarm.trigger('velocity');
        if(state.modules.geo.active && state.base.geoStart) {
            const d = mapLogic.dist(lat, lng, state.base.geoStart[0], state.base.geoStart[1]);
            if(d > state.modules.geo.thresh) alarm.trigger('geo');
        }
    },
    plotEvasion: () => {
        if(!sys.map || !mapLogic.lastPos) return;
        sys.threatMark = L.circleMarker(mapLogic.lastPos, {color:'red', radius:20}).addTo(sys.map);
        const safeLat = mapLogic.lastPos[0] + 0.005; 
        const safeLng = mapLogic.lastPos[1] + 0.005;
        L.polyline([mapLogic.lastPos, [safeLat, safeLng]], {color:'#00ff41', dashArray:'5,10'}).addTo(sys.map);
        document.getElementById('map-alert').style.display = 'block';
    },
    dist: (lat1, lon1, lat2, lon2) => {
        const R=6371e3; const p1=lat1*Math.PI/180, p2=lat2*Math.PI/180;
        const dp=(lat2-lat1)*Math.PI/180, dl=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dp/2)**2+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
};

// --- ALARM ---
const alarm = {
    trigger: (id) => {
        const row = document.getElementById(`mod-${id}`);
        if(row.classList.contains('triggered')) return;

        row.classList.add('triggered');
        
        // Siren
        const o = sys.ctx.createOscillator();
        const g = sys.ctx.createGain();
        o.connect(g); g.connect(sys.ctx.destination);
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(600, sys.ctx.currentTime);
        o.frequency.linearRampToValueAtTime(1200, sys.ctx.currentTime+0.3);
        o.start(); o.stop(sys.ctx.currentTime+1);

        // Strobe
        if(id === 'intruder' || id === 'audio') {
            const s = document.getElementById('strobe-fx');
            s.style.display='block'; s.style.animation='strobe 0.1s infinite';
            setTimeout(() => { s.style.display='none'; s.style.animation='none'; }, 4000);
        }

        logger.add(CONFIG.find(m=>m.id===id).name, "TRIGGERED");
        setTimeout(() => row.classList.remove('triggered'), 3000);
    },
    panic: () => {
        alarm.trigger('audio');
        alert("PANIC BEACON SENT (Simulated)");
    },
    stopStrobe: () => { document.getElementById('strobe-fx').style.display='none'; }
};

const logger = {
    items: [],
    add: (mod, evt) => {
        const t = new Date().toLocaleTimeString();
        logger.items.unshift(`[${t}] ${mod}: ${evt}`);
        document.getElementById('log-container').innerHTML = logger.items.map(l => `<div class="log-item alert">${l}</div>`).join('');
    },
    download: () => {
        const b = new Blob([logger.items.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'intel_log.txt';
        a.click();
    }
};

// --- UI ---
const ui = {
    render: () => {
        const list = document.getElementById('module-list');
        list.innerHTML = '';
        
        CONFIG.forEach(m => {
            const st = state.modules[m.id];
            const armedClass = st.active ? 'armed' : '';
            const selClass = st.selected ? 'selected' : '';
            const statusText = st.active ? (m.id==='lumen' && !st.ready ? 'CALIBRATING...' : 'ACTIVE') : 'STANDBY';
            
            list.innerHTML += `
            <div id="mod-${m.id}" class="module-row ${selClass} ${armedClass}" onclick="ui.select('${m.id}')">
                <i class="material-icons mod-icon">${m.icon}</i>
                <div class="mod-info">
                    <div class="mod-title">${m.name}</div>
                    <div class="mod-desc">${m.desc}</div>
                    <div class="meter-track">
                        <div class="meter-trig" style="left:${st.thresh}%"></div>
                        <div class="meter-fill" id="bar-${m.id}"></div>
                    </div>
                    <div class="status-badge">${statusText}</div>
                </div>
                <div style="text-align:right">
                    <i class="material-icons gear-btn" onclick="ui.settings('${m.id}', event)">settings</i>
                    <div class="chk-wrap">
                        <input type="checkbox" class="chk-box" ${st.selected ? 'checked' : ''} disabled>
                    </div>
                </div>
            </div>`;
        });
    },
    select: (id) => {
        state.modules[id].selected = !state.modules[id].selected;
        ui.render();
    },
    settings: (id, e) => {
        e.stopPropagation();
        ui.cur = id;
        const m = CONFIG.find(x => x.id === id);
        const st = state.modules[id];
        
        document.getElementById('set-title').innerText = m.name;
        let html = '';
        
        if(m.type !== 'logic') {
            html += `<label style="color:#aaa; font-size:0.8rem">SENSITIVITY THRESHOLD: <span id="lbl-val">${st.thresh}</span></label>
                     <input type="range" min="1" max="100" value="${st.thresh}" oninput="ui.save(this.value)">`;
        } else if (id === 'deadman') {
            html += `<label style="color:#aaa; font-size:0.8rem">TIMER (MINUTES): <span id="lbl-val">${m.thresh}</span></label>
                     <input type="range" min="1" max="60" value="${m.thresh}" oninput="ui.save(this.value)">`;
        } else {
            html += `<div style="color:#666; font-style:italic;">No adjustable settings for this module.</div>`;
        }
        
        document.getElementById('set-body').innerHTML = html;
        document.getElementById('settings-modal').classList.add('open');
    },
    save: (val) => {
        state.modules[ui.cur].thresh = parseInt(val);
        document.getElementById('lbl-val').innerText = val;
        ui.render();
    },
    closeSettings: () => document.getElementById('settings-modal').classList.remove('open'),
    updateMeters: () => {
        CONFIG.forEach(m => {
            const el = document.getElementById(`bar-${m.id}`);
            if(el) el.style.width = state.values[m.id] + '%';
        });
    }
};

function nav(tab) {
    document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById(`view-${tab}`).classList.add('active');
    // Simple tab highlighting logic omitted for brevity, would match index
    if(tab === 'map') setTimeout(() => sys.map.invalidateSize(), 200);
}
</script>
</body>
</html>
