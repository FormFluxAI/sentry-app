<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANGUARD: BLACK OPS</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-amber: #ffae00;
            --neon-red: #ff003c;
            --bg-dark: #050505;
            --glass: rgba(20, 20, 20, 0.8);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background-color: var(--bg-dark);
            color: #eee; margin: 0; height: 100vh; display: flex; flex-direction: column;
            background-image: linear-gradient(0deg, transparent 24%, rgba(0, 243, 255, .03) 25%, rgba(0, 243, 255, .03) 26%, transparent 27%, transparent 74%, rgba(0, 243, 255, .03) 75%, rgba(0, 243, 255, .03) 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, rgba(0, 243, 255, .03) 25%, rgba(0, 243, 255, .03) 26%, transparent 27%, transparent 74%, rgba(0, 243, 255, .03) 75%, rgba(0, 243, 255, .03) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
        }

        /* HEADER */
        header {
            padding: 15px; border-bottom: 1px solid #333; background: rgba(0,0,0,0.9);
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .brand { font-weight: 900; letter-spacing: 2px; color: var(--neon-cyan); font-size: 1.2rem; }
        
        /* SCROLL AREA */
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        .section-title {
            font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 1px;
            margin: 20px 0 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px;
        }

        /* GRID SYSTEM */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .card {
            background: var(--glass); border: 1px solid #333; border-radius: 12px;
            padding: 15px; position: relative; transition: 0.3s; min-height: 130px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card.active { border-color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); background: rgba(0, 40, 40, 0.6); }
        .card.alert { border-color: var(--neon-red); animation: flash 0.5s infinite; }
        
        .icon { font-size: 2rem; color: #555; margin-bottom: 5px; }
        .card.active .icon { color: var(--neon-cyan); }
        
        h3 { margin: 0; font-size: 0.9rem; }
        p { margin: 5px 0 0 0; font-size: 0.65rem; color: #888; line-height: 1.2; }

        /* TOGGLE */
        .switch { position: absolute; top: 12px; right: 12px; width: 30px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; inset: 0; background: #333; border-radius: 20px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background: var(--neon-cyan); }
        input:checked + .slider:before { transform: translateX(12px); }

        /* DEAD MAN TIMER OVERLAY */
        .timer-badge {
            position: absolute; bottom: 10px; right: 10px; font-family: monospace;
            color: var(--neon-amber); font-weight: bold; display: none;
        }

        /* PANIC FOOTER */
        .dock {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.9); border-top: 1px solid #333;
            display: flex; gap: 10px; padding: 10px 20px; z-index: 100;
        }
        .btn-panic {
            flex: 2; background: var(--neon-red); color: white; border: none; border-radius: 8px;
            font-size: 1.2rem; font-weight: 900; letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(255, 0, 60, 0.3);
        }
        .btn-tool { flex: 1; background: #222; border: 1px solid #444; color: var(--neon-cyan); border-radius: 8px; }

        /* HIDDEN SENSORS */
        video { position: fixed; top: -1000px; left: -1000px; }
        
        @keyframes flash { 0%, 100% { background: rgba(50,0,0,0.5); } 50% { background: rgba(100,0,0,0.8); } }
    </style>
</head>
<body>

<header>
    <div class="brand">VANGUARD <span style="font-size:0.5em; color:#666; vertical-align: middle;">BLACK OPS</span></div>
    <div style="font-size: 0.7rem; color: var(--neon-cyan);" id="gpsStatus">GPS: SEARCHING</div>
</header>

<main>

    <div class="section-title">KINETIC DEFENSE</div>
    <div class="grid">
        <div class="card" id="card-intruder">
            <label class="switch"><input type="checkbox" onchange="toggle('intruder')"><span class="slider"></span></label>
            <i class="material-icons icon">motion_photos_on</i>
            <h3>Visual Sentry</h3>
            <p>Motion detection via camera. Auto-records.</p>
        </div>
        <div class="card" id="card-snoop">
            <label class="switch"><input type="checkbox" onchange="toggle('snoop')"><span class="slider"></span></label>
            <i class="material-icons icon">touch_app</i>
            <h3>Snoop Trap</h3>
            <p>Triggers if device is touched or moved.</p>
        </div>
        <div class="card" id="card-wreck">
            <label class="switch"><input type="checkbox" onchange="toggle('wreck')"><span class="slider"></span></label>
            <i class="material-icons icon">car_crash</i>
            <h3>Wreck Detect</h3>
            <p>High-G impact detection (Car/Bike).</p>
        </div>
        <div class="card" id="card-mag">
            <label class="switch"><input type="checkbox" onchange="toggle('mag')"><span class="slider"></span></label>
            <i class="material-icons icon">explore</i>
            <h3>Mag-Field</h3>
            <p>Detects magnets/metal moving nearby.</p>
        </div>
    </div>

    <div class="section-title">LOGIC & SITUATIONAL</div>
    <div class="grid">
        <div class="card" id="card-audio">
            <label class="switch"><input type="checkbox" onchange="toggle('audio')"><span class="slider"></span></label>
            <i class="material-icons icon">graphic_eq</i>
            <h3>Shot Spotter</h3>
            <p>High-Decibel impulse detection.</p>
        </div>
        <div class="card" id="card-power">
            <label class="switch"><input type="checkbox" onchange="toggle('power')"><span class="slider"></span></label>
            <i class="material-icons icon">battery_alert</i>
            <h3>Power Leech</h3>
            <p>Alarms if charging cable is unplugged.</p>
        </div>
        <div class="card" id="card-geo">
            <label class="switch"><input type="checkbox" onchange="toggle('geo')"><span class="slider"></span></label>
            <i class="material-icons icon">fmd_good</i>
            <h3>Perimeter</h3>
            <p>Alarms if device moves >50m from here.</p>
        </div>
        <div class="card" id="card-deadman" onclick="resetDeadman()">
            <label class="switch"><input type="checkbox" id="chk-deadman" onchange="toggle('deadman')"><span class="slider"></span></label>
            <i class="material-icons icon">hourglass_bottom</i>
            <h3>Dead Man</h3>
            <p>Tap to reset timer or Panic triggers.</p>
            <div class="timer-badge" id="dm-timer">05:00</div>
        </div>
    </div>
</main>

<div class="dock">
    <button class="btn-panic" id="panicBtn" onclick="triggerPanic()">PANIC</button>
    <button class="btn-tool" onclick="downloadLogs()"><i class="material-icons">download</i></button>
</div>

<video id="cam" autoplay playsinline muted></video>
<canvas id="cvs" style="display:none;"></canvas>

<script>
    // --- CORE VARIABLES ---
    const state = { intruder:false, snoop:false, wreck:false, mag:false, audio:false, power:false, geo:false, deadman:false };
    const logs = [];
    let startLoc = null;
    let currentLoc = null;
    let dmInterval = null;
    let dmTime = 300; // 5 minutes default
    let stream = null;
    let audioCtx, analyser, dataArray;
    let lastMag = 0;

    // --- INIT ---
    // User must click once to start audio context and sensors
    document.body.addEventListener('click', async () => {
        if(stream) return;
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
            document.getElementById('cam').srcObject = stream;
            
            if(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                await DeviceMotionEvent.requestPermission();
            }

            // Init Audio
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaStreamSource(stream);
            src.connect(analyser);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Init Loops
            requestAnimationFrame(sensorLoop);
            setInterval(videoLoop, 500);
            initGPS();
            initBattery();
            
            log("System", "Vanguard Black Ops Initialized");
        } catch(e) { console.error(e); alert("Sensors blocked by browser."); }
    }, {once:true});

    // --- SENSOR LOOPS ---
    function sensorLoop() {
        requestAnimationFrame(sensorLoop);
        
        // 1. Audio Logic
        if(state.audio && analyser) {
            analyser.getByteFrequencyData(dataArray);
            const vol = dataArray.reduce((a,b)=>a+b)/dataArray.length;
            if(vol > 200) alarm("audio", "GUNSHOT/EXPLOSION DETECTED");
        }
    }

    // 2. Video Logic
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const vid = document.getElementById('cam');
    let lastLight = 0;

    function videoLoop() {
        if(!state.intruder) return;
        cvs.width = 100; cvs.height = 100;
        ctx.drawImage(vid, 0, 0, 100, 100);
        const frame = ctx.getImageData(0,0,100,100);
        let light = 0; 
        for(let i=0; i<frame.data.length; i+=4) light += frame.data[i];
        
        if(Math.abs(light - lastLight) > 30000) alarm("intruder", "VISUAL MOVEMENT");
        lastLight = light;
    }

    // 3. Motion & Mag Sensors
    window.addEventListener('devicemotion', e => {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        
        // Wreck (G-Force)
        const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;
        if(state.wreck && g > 4) alarm("wreck", `IMPACT DETECTED: ${g.toFixed(1)}G`);

        // Snoop (Tilt)
        if(state.snoop) {
            if(!window.baseAcc) window.baseAcc = acc;
            const diff = Math.abs(acc.x - window.baseAcc.x) + Math.abs(acc.y - window.baseAcc.y);
            if(diff > 2) alarm("snoop", "DEVICE MOVED");
        }
    });
    
    // Magnetometer (If supported)
    if('Magnetometer' in window) {
        const magSensor = new Magnetometer({frequency: 10});
        magSensor.addEventListener('reading', () => {
            if(!state.mag) return;
            const mag = Math.sqrt(magSensor.x**2 + magSensor.y**2 + magSensor.z**2);
            if(lastMag !== 0 && Math.abs(mag - lastMag) > 50) alarm("mag", "MAGNETIC FIELD DISRUPTION");
            lastMag = mag;
        });
        magSensor.start();
    }

    // --- NEW LOGIC MODULES ---

    // 4. Power Leech
    async function initBattery() {
        if('getBattery' in navigator) {
            const bat = await navigator.getBattery();
            bat.addEventListener('chargingchange', () => {
                if(state.power && !bat.charging) alarm("power", "POWER CABLE DISCONNECTED");
            });
        }
    }

    // 5. Perimeter (Geofence)
    function initGPS() {
        navigator.geolocation.watchPosition(pos => {
            currentLoc = pos.coords;
            document.getElementById('gpsStatus').innerText = `GPS: LOCKED (${pos.coords.accuracy.toFixed(0)}m)`;
            
            if(state.geo && startLoc) {
                const d = getDist(startLoc.latitude, startLoc.longitude, currentLoc.latitude, currentLoc.longitude);
                if(d > 0.05) alarm("geo", `PERIMETER BREACH (${(d*1000).toFixed(0)}m)`); // 0.05km = 50m
            }
        }, e => {}, {enableHighAccuracy:true});
    }

    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // 6. Dead Man's Switch
    function startDeadman() {
        document.getElementById('dm-timer').style.display = 'block';
        dmTime = 300; // Reset to 5 mins
        dmInterval = setInterval(() => {
            dmTime--;
            const m = Math.floor(dmTime/60);
            const s = dmTime%60;
            document.getElementById('dm-timer').innerText = `${m}:${s<10?'0':''}${s}`;
            
            if(dmTime <= 0) {
                alarm("deadman", "USER UNRESPONSIVE");
                triggerPanic(); // Auto panic
                clearInterval(dmInterval);
            }
        }, 1000);
    }

    function resetDeadman() {
        if(state.deadman) {
            dmTime = 300; // Reset
            // Visual feedback
            const card = document.getElementById('card-deadman');
            card.style.background = "var(--neon-cyan)";
            setTimeout(() => card.style.background = "", 200);
        }
    }

    // --- UTILS ---
    function toggle(mode) {
        state[mode] = !state[mode];
        const card = document.getElementById('card-'+mode);
        if(state[mode]) {
            card.classList.add('active');
            if(mode === 'snoop') window.baseAcc = null; // Reset baseline
            if(mode === 'geo') startLoc = currentLoc; // Set fence post
            if(mode === 'deadman') startDeadman();
        } else {
            card.classList.remove('active');
            card.classList.remove('alert');
            if(mode === 'deadman') { clearInterval(dmInterval); document.getElementById('dm-timer').style.display='none'; }
        }
    }

    function alarm(mode, msg) {
        if(document.getElementById('card-'+mode).classList.contains('alert')) return;
        
        // Flash UI
        const card = document.getElementById('card-'+mode);
        card.classList.add('alert');
        setTimeout(() => card.classList.remove('alert'), 4000);
        
        // Log & Capture
        cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
        ctx.drawImage(vid, 0,0);
        const img = cvs.toDataURL('image/jpeg');
        log(mode.toUpperCase(), msg, img);
        
        // Sound
        playBeep();
    }

    function log(type, msg, img=null) {
        const time = new Date().toLocaleTimeString();
        logs.push({time, type, msg});
        console.log(`[${type}] ${msg}`);
    }

    function playBeep() {
        if(!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = 1000;
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    let panic = false;
    let sirenOsc;
    function triggerPanic() {
        panic = !panic;
        const btn = document.getElementById('panicBtn');
        if(panic) {
            btn.style.background = "#fff"; btn.style.color="red"; btn.innerText="STOP";
            // Siren
            if(audioCtx.state === 'suspended') audioCtx.resume();
            sirenOsc = audioCtx.createOscillator();
            sirenOsc.type = 'sawtooth';
            sirenOsc.connect(audioCtx.destination);
            sirenOsc.start();
            // simple ramp
            setInterval(() => {
               if(!panic) return;
               const t = audioCtx.currentTime;
               sirenOsc.frequency.setValueAtTime(500, t);
               sirenOsc.frequency.linearRampToValueAtTime(1000, t+0.5);
            }, 500);
        } else {
            btn.style.background = ""; btn.style.color=""; btn.innerText="PANIC";
            if(sirenOsc) { sirenOsc.stop(); sirenOsc=null; }
            location.reload(); // Hard reset on stop
        }
    }
    
    function downloadLogs() {
        let txt = "VANGUARD LOG:\n";
        logs.forEach(l => txt += `[${l.time}] ${l.type}: ${l.msg}\n`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
        a.download = 'vanguard_logs.txt';
        a.click();
    }
</script>
</body>
</html>
