<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANGUARD ECLIPSE</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #141414; --text: #eee; --accent: #00f3ff; --danger: #ff003c; --success: #00ff41; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        header { padding: 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; letter-spacing: 2px; color: var(--accent); }
        .status { font-size: 0.7rem; font-weight: bold; color: #666; }
        
        /* GRID LAYOUT */
        .grid { flex: 1; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        
        .card { 
            background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 15px; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; position: relative;
            transition: 0.2s;
        }
        
        .card.armed { border-color: var(--success); background: rgba(0, 50, 0, 0.2); }
        .card.alert { border-color: var(--danger); background: rgba(50, 0, 0, 0.5); animation: pulse 0.5s infinite; }
        
        .card-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .icon { font-size: 1.8rem; color: #555; }
        .card.armed .icon { color: var(--success); }
        
        .label { font-weight: bold; font-size: 0.9rem; }
        .sub { font-size: 0.7rem; color: #888; }
        
        /* VISUALIZER BARS */
        .vis-container { 
            height: 6px; background: #222; border-radius: 3px; margin-top: 10px; position: relative; overflow: hidden; 
        }
        .vis-bar { 
            height: 100%; width: 0%; background: var(--accent); transition: width 0.1s; 
        }
        .vis-trigger {
            position: absolute; top: 0; bottom: 0; width: 2px; background: var(--danger); z-index: 10;
        }
        
        /* FOOTER */
        .footer { padding: 15px; background: #000; border-top: 1px solid #333; display: flex; gap: 10px; }
        .btn { flex: 1; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-start { background: var(--accent); color: #000; }
        .btn-panic { background: var(--danger); color: #fff; flex: 0.4; }

        @keyframes pulse { 0%, 100% { border-color: var(--danger); } 50% { border-color: #000; } }
        
        /* HIDDEN */
        video { position: fixed; top: -1000px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">VANGUARD</div>
        <div class="status" id="sys-status">OFFLINE</div>
    </header>

    <div class="grid">
        <div class="card" id="card-audio" onclick="app.toggle('audio')">
            <div class="card-head"><i class="material-icons icon">graphic_eq</i></div>
            <div><div class="label">AUDIO</div><div class="sub">Gunshot / Scream</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 70%;"></div>
                <div class="vis-bar" id="bar-audio"></div>
            </div>
        </div>

        <div class="card" id="card-seismic" onclick="app.toggle('seismic')">
            <div class="card-head"><i class="material-icons icon">vibration</i></div>
            <div><div class="label">SEISMIC</div><div class="sub">Vibration / Door</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 20%;"></div>
                <div class="vis-bar" id="bar-seismic"></div>
            </div>
        </div>

        <div class="card" id="card-lumen" onclick="app.toggle('lumen')">
            <div class="card-head"><i class="material-icons icon">light_mode</i></div>
            <div><div class="label">LUMEN</div><div class="sub">Pocket Trap</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 80%;"></div>
                <div class="vis-bar" id="bar-lumen"></div>
            </div>
        </div>

        <div class="card" id="card-intruder" onclick="app.toggle('intruder')">
            <div class="card-head"><i class="material-icons icon">videocam</i></div>
            <div><div class="label">INTRUDER</div><div class="sub">Visual Motion</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 50%;"></div>
                <div class="vis-bar" id="bar-intruder"></div>
            </div>
        </div>
        
        <div class="card" id="card-wreck" onclick="app.toggle('wreck')">
            <div class="card-head"><i class="material-icons icon">car_crash</i></div>
            <div><div class="label">WRECK</div><div class="sub">G-Force Impact</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 40%;"></div>
                <div class="vis-bar" id="bar-wreck"></div>
            </div>
        </div>

        <div class="card" id="card-snoop" onclick="app.toggle('snoop')">
            <div class="card-head"><i class="material-icons icon">touch_app</i></div>
            <div><div class="label">SNOOP</div><div class="sub">Device Tilt</div></div>
            <div class="vis-container">
                <div class="vis-trigger" style="left: 10%;"></div>
                <div class="vis-bar" id="bar-snoop"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-start" id="btn-main" onclick="app.init()">ACTIVATE SENSORS</button>
        <button class="btn btn-panic" onclick="app.panic()">PANIC</button>
    </div>

    <video id="cam" autoplay playsinline muted></video>
    <canvas id="cvs" style="display:none;"></canvas>

<script>
    const app = {
        active: false,
        ctx: null,
        stream: null,
        analyser: null,
        accBase: null,
        lastLight: 0,
        
        // CONFIG: [Armed?, Threshold(0-100), CurrentVal(0-100)]
        mods: {
            audio: { armed: false, thresh: 70, val: 0 },
            seismic: { armed: false, thresh: 20, val: 0 },
            lumen: { armed: false, thresh: 80, val: 0 }, // Trigger if > 80 brightness
            intruder: { armed: false, thresh: 50, val: 0 },
            wreck: { armed: false, thresh: 40, val: 0 },
            snoop: { armed: false, thresh: 10, val: 0 }
        },

        init: async () => {
            document.getElementById('btn-main').innerText = "INITIALIZING...";
            
            try {
                // Audio
                app.ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Camera
                app.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                document.getElementById('cam').srcObject = app.stream;
                
                // Audio Analyzer
                app.analyser = app.ctx.createAnalyser();
                const src = app.ctx.createMediaStreamSource(app.stream);
                src.connect(app.analyser);

                // Motion
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    await DeviceMotionEvent.requestPermission();
                }

                // Loops
                app.active = true;
                requestAnimationFrame(app.visLoop);
                window.addEventListener('devicemotion', app.motionLoop);
                
                document.getElementById('sys-status').innerText = "ONLINE - READY TO ARM";
                document.getElementById('sys-status').style.color = "var(--accent)";
                document.getElementById('btn-main').innerText = "DISARM ALL";
                document.getElementById('btn-main').style.background = "#333";
                document.getElementById('btn-main').style.color = "#fff";
                document.getElementById('btn-main').onclick = app.disarmAll;

            } catch(e) {
                alert("SENSOR ERROR: " + e.message + ". Check permissions/HTTPS.");
                document.getElementById('btn-main').innerText = "RETRY";
            }
        },

        toggle: (id) => {
            if(!app.active) return alert("Click ACTIVATE SENSORS first.");
            
            const m = app.mods[id];
            m.armed = !m.armed;
            
            const el = document.getElementById(`card-${id}`);
            if(m.armed) {
                el.classList.add('armed');
                // Resume Audio Context on interaction
                if(app.ctx.state === 'suspended') app.ctx.resume();
                
                // Reset baselines for motion
                if(id === 'seismic' || id === 'snoop') app.accBase = null;
            } else {
                el.classList.remove('armed', 'alert');
            }
        },

        disarmAll: () => {
            Object.keys(app.mods).forEach(k => {
                app.mods[k].armed = false;
                document.getElementById(`card-${k}`).classList.remove('armed', 'alert');
            });
        },

        // --- SENSOR PROCESSING ---
        visLoop: () => {
            if(!app.active) return;
            requestAnimationFrame(app.visLoop);
            
            // 1. VIDEO (Intruder/Lumen)
            const cvs = document.getElementById('cvs');
            const ctx = cvs.getContext('2d');
            const vid = document.getElementById('cam');
            
            if(vid.readyState === vid.HAVE_ENOUGH_DATA) {
                cvs.width=50; cvs.height=50;
                ctx.drawImage(vid,0,0,50,50);
                const d = ctx.getImageData(0,0,50,50).data;
                let l=0; for(let i=0; i<d.length; i+=4) l+=d[i];
                const avg = l/2500; // 0-255
                
                // Lumen (Raw brightness 0-100%)
                const lightPct = (avg / 255) * 100;
                app.updateBar('lumen', lightPct);
                
                // Intruder (Delta)
                const delta = Math.abs(avg - app.lastLight);
                const motionPct = Math.min((delta / 50) * 100, 100);
                app.updateBar('intruder', motionPct);

                app.lastLight = avg;
            }

            // 2. AUDIO
            if(app.analyser) {
                const d = new Uint8Array(app.analyser.frequencyBinCount);
                app.analyser.getByteFrequencyData(d);
                const vol = d.reduce((a,b)=>a+b)/d.length;
                const audPct = (vol / 255) * 100;
                app.updateBar('audio', audPct);
            }
        },

        motionLoop: (e) => {
            if(!app.active) return;
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            if(!app.accBase) app.accBase = acc;

            const diff = Math.abs(acc.x-app.accBase.x) + Math.abs(acc.y-app.accBase.y);
            const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;

            // Seismic (Very Sensitive)
            // Multiplier to make small moves visible on bar
            const seisPct = Math.min(diff * 50, 100); 
            app.updateBar('seismic', seisPct);

            // Snoop (Tilt)
            const snoopPct = Math.min(diff * 10, 100);
            app.updateBar('snoop', snoopPct);

            // Wreck (G Force)
            // Scale: 1G = 0%, 5G = 100%
            const wreckPct = Math.min(((g - 1) / 4) * 100, 100);
            app.updateBar('wreck', wreckPct);

            // Drift
            app.accBase.x += (acc.x - app.accBase.x) * 0.05;
            app.accBase.y += (acc.y - app.accBase.y) * 0.05;
        },

        updateBar: (id, val) => {
            const m = app.mods[id];
            // Update Bar Width
            document.getElementById(`bar-${id}`).style.width = val + "%";
            
            // Trigger Logic
            if(m.armed && val > m.thresh) {
                app.trigger(id);
            }
        },

        trigger: (id) => {
            const el = document.getElementById(`card-${id}`);
            if(el.classList.contains('alert')) return;
            
            el.classList.add('alert');
            app.playSiren();
            
            setTimeout(() => el.classList.remove('alert'), 2000);
        },

        playSiren: () => {
            if(!app.ctx) return;
            const o = app.ctx.createOscillator();
            const g = app.ctx.createGain();
            o.connect(g); g.connect(app.ctx.destination);
            o.type = 'sawtooth';
            o.frequency.value = 800;
            o.start(); 
            o.stop(app.ctx.currentTime + 0.5);
        },

        panic: () => {
            alert("PANIC BEACON");
        }
    };
</script>
</body>
</html>
