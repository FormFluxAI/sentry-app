<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VANGUARD TITAN</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-green: #00ff41;
            --neon-red: #ff003c;
            --bg: #050505;
            --panel: #121212;
            --border: 1px solid #333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        body {
            background-color: var(--bg); color: #eee; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- LOGIN --- */
        #login-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s;
        }
        .login-box { width: 80%; max-width: 300px; text-align: center; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 8px; text-align: center; }
        .login-btn { width: 100%; padding: 15px; background: var(--neon-blue); font-weight: bold; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; }

        /* --- HEADER --- */
        header {
            padding: 15px; background: rgba(0,0,0,0.9); border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .brand { color: var(--neon-blue); font-weight: 900; letter-spacing: 1px; }
        .back-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; }

        /* --- VIEWS --- */
        #viewport { flex: 1; position: relative; overflow: hidden; }
        .view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; padding: 15px; padding-bottom: 100px;
            background: var(--bg); transition: transform 0.3s; transform: translateX(100%);
        }
        .view.active { transform: translateX(0); }

        /* --- GRID --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card {
            background: var(--panel); border: var(--border); border-radius: 10px; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between; min-height: 120px;
            position: relative;
        }
        .card.armed { border-color: var(--neon-green); background: rgba(0, 50, 0, 0.2); }
        .card.alert { border-color: var(--neon-red); background: rgba(50, 0, 0, 0.5); animation: flash 0.5s infinite; }
        .dot { position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .card.armed .dot { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        
        h3 { margin: 0; font-size: 0.85rem; margin-top: 5px; }
        p { margin: 0; font-size: 0.65rem; color: #888; }
        .icon { font-size: 1.8rem; color: #666; }
        .card.armed .icon { color: var(--neon-green); }

        /* --- DETAIL VIEW --- */
        .big-toggle {
            width: 100%; padding: 20px; background: #222; border: 1px solid #444; color: #fff;
            font-size: 1.2rem; border-radius: 12px; margin-top: 20px;
        }
        .big-toggle.armed { background: var(--neon-green); color: black; border-color: var(--neon-green); }
        
        .slider-container { margin: 20px 0; }
        input[type=range] { width: 100%; background: #333; }

        /* --- FOOTER --- */
        .footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #000; border-top: var(--border); display: flex; z-index: 200;
            padding: 10px; gap: 10px;
        }
        .panic-btn { flex: 2; background: var(--neon-red); color: white; border: none; border-radius: 8px; font-weight: 900; letter-spacing: 2px; }
        .log-btn { flex: 1; background: #222; color: #ccc; border: 1px solid #444; border-radius: 8px; }

        @keyframes flash { 0%, 100% { border-color: var(--neon-red); } 50% { border-color: #000; } }
        video { position: fixed; top: -5000px; }
    </style>
</head>
<body>

    <div id="login-layer">
        <div class="login-box">
            <h1 style="color:var(--neon-blue); letter-spacing:3px; margin-bottom:0;">VANGUARD</h1>
            <p style="color:#666; font-size:0.8rem; margin-bottom:30px;">TITAN EDITION v5.0</p>
            <input type="email" class="login-input" placeholder="ACCESS ID (Any Email)" id="loginId">
            <button class="login-btn" onclick="login()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <header>
        <button class="back-btn" id="backBtn" onclick="goHome()"><i class="material-icons">arrow_back</i></button>
        <div class="brand">VANGUARD</div>
        <div style="font-size:0.7rem; color:#666;" id="gps-status">GPS: ...</div>
    </header>

    <div id="viewport">
        <div id="dashboard" class="view active">
            <div style="margin-bottom: 10px; font-size: 0.7rem; color: #555; font-weight: bold;">VISUAL & KINETIC</div>
            <div class="grid">
                <div class="card" id="card-intruder" onclick="openDetail('intruder')">
                    <div class="dot"></div><i class="material-icons icon">motion_photos_on</i>
                    <div><h3>Intruder</h3><p>Motion Cam</p></div>
                </div>
                <div class="card" id="card-seismic" onclick="openDetail('seismic')">
                    <div class="dot"></div><i class="material-icons icon">vibration</i>
                    <div><h3>Seismic</h3><p>Door Guard</p></div>
                </div>
                <div class="card" id="card-lumen" onclick="openDetail('lumen')">
                    <div class="dot"></div><i class="material-icons icon">light_mode</i>
                    <div><h3>Lumen</h3><p>Pocket Trap</p></div>
                </div>
                <div class="card" id="card-snoop" onclick="openDetail('snoop')">
                    <div class="dot"></div><i class="material-icons icon">touch_app</i>
                    <div><h3>Snoop</h3><p>Device Tilt</p></div>
                </div>
            </div>

            <div style="margin: 20px 0 10px 0; font-size: 0.7rem; color: #555; font-weight: bold;">ENVIRONMENTAL & LOGIC</div>
            <div class="grid">
                <div class="card" id="card-audio" onclick="openDetail('audio')">
                    <div class="dot"></div><i class="material-icons icon">graphic_eq</i>
                    <div><h3>Audio</h3><p>Gunshot/Scream</p></div>
                </div>
                <div class="card" id="card-wreck" onclick="openDetail('wreck')">
                    <div class="dot"></div><i class="material-icons icon">car_crash</i>
                    <div><h3>Wreck</h3><p>Impact Detect</p></div>
                </div>
                 <div class="card" id="card-mag" onclick="openDetail('mag')">
                    <div class="dot"></div><i class="material-icons icon">explore</i>
                    <div><h3>Mag-Field</h3><p>Metal Detect</p></div>
                </div>
                <div class="card" id="card-power" onclick="openDetail('power')">
                    <div class="dot"></div><i class="material-icons icon">battery_alert</i>
                    <div><h3>Pwr Leech</h3><p>Cable Unplug</p></div>
                </div>
                <div class="card" id="card-deadman" onclick="openDetail('deadman')">
                    <div class="dot"></div><i class="material-icons icon">hourglass_bottom</i>
                    <div><h3>Dead Man</h3><p>Safety Timer</p></div>
                </div>
                <div class="card" id="card-geo" onclick="openDetail('geo')">
                    <div class="dot"></div><i class="material-icons icon">share_location</i>
                    <div><h3>Perimeter</h3><p>GPS Fence</p></div>
                </div>
            </div>
        </div>

        <div id="detail" class="view">
            <h1 id="det-title" style="color:var(--neon-blue); margin-top:0;">MODULE</h1>
            <p id="det-desc" style="color:#888;">Description</p>
            
            <div class="slider-container" id="sens-ui">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:0.8rem; color:#aaa;">SENSITIVITY</span>
                    <span id="det-val" style="font-size:0.8rem; color:white;">50%</span>
                </div>
                <input type="range" min="1" max="100" id="det-slider" oninput="updateSens(this.value)">
            </div>

            <div id="dm-ui" style="display:none; text-align:center; margin:20px 0;">
                <div id="dm-timer" style="font-size:3rem; font-family:monospace; color:var(--neon-red);">05:00</div>
                <button onclick="resetDeadman()" style="padding:10px; background:#333; color:white; border:none; border-radius:5px; margin-top:10px;">RESET TIMER</button>
            </div>

            <button class="big-toggle" id="arm-btn" onclick="toggleArm()">ARM MODULE</button>

            <div style="background:#111; padding:15px; border-radius:8px; margin-top:20px;">
                <label style="font-size:0.7rem; color:#555;">LIVE SENSOR DATA</label>
                <div id="live-data" style="font-family:monospace; color:var(--neon-green); font-size:1.1rem; margin-top:5px;">--</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="panic-btn" onclick="panic()">PANIC</button>
        <button class="log-btn" onclick="downloadLogs()"><i class="material-icons">download</i></button>
    </div>

    <video id="cam" autoplay playsinline muted></video>
    <canvas id="cvs" style="display:none;"></canvas>

<script>
    // --- 1. CONFIG & STATE ---
    const mods = {
        intruder: { name:"Intruder", desc:"Visual Motion Detection", armed:false, sens:50, type:'visual' },
        seismic: { name:"Seismic", desc:"Micro-Vibration (Door/Surface)", armed:false, sens:85, type:'kinetic' },
        lumen: { name:"Lumen", desc:"Sudden Light (Pocket Trap)", armed:false, sens:50, type:'visual' },
        snoop: { name:"Snoop", desc:"Device Tilt/Movement", armed:false, sens:90, type:'kinetic' },
        audio: { name:"Audio", desc:"Gunshot/Impact Sound", armed:false, sens:70, type:'audio' },
        wreck: { name:"Wreck", desc:"High G-Force Crash", armed:false, sens:40, type:'kinetic' },
        mag: { name:"Mag-Field", desc:"Magnetic Interference", armed:false, sens:60, type:'env' },
        power: { name:"Pwr Leech", desc:"Charger Disconnect", armed:false, sens:null, type:'logic' },
        deadman: { name:"Dead Man", desc:"Inactivity Timer", armed:false, sens:null, type:'logic' },
        geo: { name:"Perimeter", desc:"50m GPS Geofence", armed:false, sens:null, type:'env' }
    };

    let curMod = null;
    let stream = null;
    let audioCtx, analyser;
    let logs = [];
    let watchId = null;
    let startLoc = null;
    let dmTime = 300; 
    let dmInt = null;
    let lastAcc = null;
    let lastLight = 0;
    
    // --- 2. INIT ---
    function login() {
        if(document.getElementById('loginId').value.length < 1) { alert("Please enter an ID"); return; }
        document.getElementById('login-layer').style.opacity = 0;
        setTimeout(() => { 
            document.getElementById('login-layer').style.display='none'; 
            startSystem();
        }, 500);
    }

    async function startSystem() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
            document.getElementById('cam').srcObject = stream;
            
            if(typeof DeviceMotionEvent.requestPermission === 'function') await DeviceMotionEvent.requestPermission();
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaStreamSource(stream);
            src.connect(analyser);

            if('getBattery' in navigator) {
                const b = await navigator.getBattery();
                b.addEventListener('chargingchange', () => { if(mods.power.armed && !b.charging) trigger('power'); });
            }

            watchId = navigator.geolocation.watchPosition(pos => {
                document.getElementById('gps-status').innerText = `GPS: ${pos.coords.latitude.toFixed(4)}`;
                if(mods.geo.armed && startLoc) {
                    const d = getDist(startLoc.lat, startLoc.lng, pos.coords.latitude, pos.coords.longitude);
                    if(d > 0.05) trigger('geo'); // 50m
                }
            }, null, {enableHighAccuracy:true});

            setInterval(loop, 200);
            requestAnimationFrame(visLoop);

        } catch(e) { alert("Sensors Blocked: " + e.message); }
    }

    // --- 3. UI NAV ---
    function goHome() {
        document.getElementById('dashboard').style.transform = "translateX(0)";
        document.getElementById('detail').style.transform = "translateX(100%)";
        document.getElementById('backBtn').style.display = 'none';
        curMod = null;
    }

    function openDetail(key) {
        curMod = key;
        const m = mods[key];
        document.getElementById('det-title').innerText = m.name;
        document.getElementById('det-desc').innerText = m.desc;
        
        // Setup Slider
        const sl = document.getElementById('sens-ui');
        if(m.sens !== null) {
            sl.style.display = 'block';
            document.getElementById('det-slider').value = m.sens;
            document.getElementById('det-val').innerText = m.sens + "%";
        } else {
            sl.style.display = 'none';
        }

        // Deadman special UI
        document.getElementById('dm-ui').style.display = key === 'deadman' ? 'block' : 'none';

        updateArmBtn();
        
        document.getElementById('dashboard').style.transform = "translateX(-100%)";
        document.getElementById('detail').style.transform = "translateX(0)";
        document.getElementById('backBtn').style.display = 'block';
    }

    function updateSens(v) {
        if(curMod) mods[curMod].sens = parseInt(v);
        document.getElementById('det-val').innerText = v + "%";
    }

    function toggleArm() {
        if(!curMod) return;
        mods[curMod].armed = !mods[curMod].armed;
        updateArmBtn();
        
        // Logic for specific mods
        if(curMod === 'geo' && mods[curMod].armed) {
            navigator.geolocation.getCurrentPosition(p => { startLoc = {lat:p.coords.latitude, lng:p.coords.longitude}; });
        }
        if(curMod === 'deadman') {
            if(mods.deadman.armed) { dmTime=300; dmInt = setInterval(dmTick, 1000); }
            else clearInterval(dmInt);
        }

        // Update Dashboard Card Visuals
        const c = document.getElementById('card-'+curMod);
        if(mods[curMod].armed) c.classList.add('armed'); else c.classList.remove('armed', 'alert');
    }

    function updateArmBtn() {
        const b = document.getElementById('arm-btn');
        if(mods[curMod].armed) {
            b.classList.add('armed'); b.innerText = "ARMED (DEACTIVATE)";
        } else {
            b.classList.remove('armed'); b.innerText = "ARM MODULE";
        }
    }

    // --- 4. SENSOR LOOPS ---
    function visLoop() {
        requestAnimationFrame(visLoop);
        if(!stream) return;
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const vid = document.getElementById('cam');
        
        cvs.width=50; cvs.height=50;
        ctx.drawImage(vid,0,0,50,50);
        const data = ctx.getImageData(0,0,50,50).data;
        
        let l = 0;
        for(let i=0; i<data.length; i+=4) l += data[i];
        const avg = l/2500;
        
        // Lumen
        if(curMod === 'lumen') document.getElementById('live-data').innerText = "LIGHT: " + Math.round(avg);
        if(mods.lumen.armed && avg > (255 - (mods.lumen.sens*2))) trigger('lumen');

        // Intruder
        const delta = Math.abs(avg - lastLight);
        if(curMod === 'intruder') document.getElementById('live-data').innerText = "DELTA: " + Math.round(delta);
        if(mods.intruder.armed && delta > (100-mods.intruder.sens)*100) trigger('intruder');
        
        lastLight = avg;
    }

    window.addEventListener('devicemotion', e => {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        
        if(!lastAcc) lastAcc = acc;
        const diff = Math.abs(acc.x-lastAcc.x) + Math.abs(acc.y-lastAcc.y);
        const g = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.8;
        
        // Seismic
        if(curMod === 'seismic') document.getElementById('live-data').innerText = "VIB: " + diff.toFixed(3);
        const seisT = (100-mods.seismic.sens)/10;
        if(mods.seismic.armed && diff > seisT) trigger('seismic');

        // Wreck
        if(curMod === 'wreck') document.getElementById('live-data').innerText = "G-FORCE: " + g.toFixed(1);
        const wreckT = 2 + ((100-mods.wreck.sens)/20);
        if(mods.wreck.armed && g > wreckT) trigger('wreck');

        // Snoop
        if(curMod === 'snoop') document.getElementById('live-data').innerText = "TILT: " + diff.toFixed(1);
        if(mods.snoop.armed && diff > 2) trigger('snoop');

        lastAcc = acc; // Rolling baseline
    });

    function loop() {
        // Audio
        if(analyser) {
            const d = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(d);
            const v = d.reduce((a,b)=>a+b)/d.length;
            if(curMod === 'audio') document.getElementById('live-data').innerText = "dB: " + Math.round(v);
            if(mods.audio.armed && v > (255-(mods.audio.sens*1.5))) trigger('audio');
        }
    }

    // --- 5. LOGIC & HELPERS ---
    function trigger(key) {
        if(document.getElementById('card-'+key).classList.contains('alert')) return;
        
        const card = document.getElementById('card-'+key);
        card.classList.add('alert');
        setTimeout(()=>card.classList.remove('alert'), 3000);
        
        // Log & Beep
        beep();
        const t = new Date().toLocaleTimeString();
        logs.unshift(`[${t}] ${mods[key].name} TRIGGERED`);
    }

    function beep() {
        if(!audioCtx) return;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = 1000;
        o.start(); o.stop(audioCtx.currentTime+0.1);
    }

    // Deadman Logic
    function dmTick() {
        dmTime--;
        const m = Math.floor(dmTime/60);
        const s = dmTime%60;
        if(curMod==='deadman') document.getElementById('dm-timer').innerText = `${m}:${s<10?'0':''}${s}`;
        if(dmTime<=0) { trigger('deadman'); panic(true); clearInterval(dmInt); }
    }
    function resetDeadman() { dmTime = 300; }

    // Panic
    let isPanic = false;
    let panOsc;
    function panic(force=false) {
        isPanic = !isPanic;
        if(force) isPanic = true;
        
        const b = document.querySelector('.panic-btn');
        if(isPanic) {
            b.style.background = "#fff"; b.style.color="red"; b.innerText="STOP";
            if(audioCtx.state==='suspended') audioCtx.resume();
            panOsc = audioCtx.createOscillator();
            panOsc.type='sawtooth'; panOsc.connect(audioCtx.destination);
            panOsc.start();
            setInterval(()=>{
                if(!isPanic) return;
                panOsc.frequency.setValueAtTime(600, audioCtx.currentTime);
                panOsc.frequency.linearRampToValueAtTime(1200, audioCtx.currentTime+0.5);
            }, 500);
        } else {
            location.reload();
        }
    }

    function downloadLogs() {
        const b = new Blob([logs.join('\n')], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download='vanguard_logs.txt';
        a.click();
    }
    
    function getDist(lat1,lon1,lat2,lon2) {
        const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
</script>
</body>
</html>
